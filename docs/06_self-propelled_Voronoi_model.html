<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Area-perimeter self-propelled Voronoi model – triangulax</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f245066ca199b7326ac6b360085ddf3a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Area-perimeter self-propelled Voronoi model – triangulax">
<meta property="og:description" content="JAX-compatible triangular meshes and triangular-mesh-based simulations">
<meta property="og:image" content="https://nikolas-claussen.github.io/triangulax/06_self-propelled_Voronoi_model_files/figure-html/cell-7-output-1.png">
<meta property="og:site_name" content="triangulax">
<meta property="og:image:height" content="351">
<meta property="og:image:width" content="384">
<meta name="twitter:title" content="Area-perimeter self-propelled Voronoi model – triangulax">
<meta name="twitter:description" content="JAX-compatible triangular meshes and triangular-mesh-based simulations">
<meta name="twitter:image" content="https://nikolas-claussen.github.io/triangulax/06_self-propelled_Voronoi_model_files/figure-html/cell-7-output-1.png">
<meta name="twitter:image-height" content="351">
<meta name="twitter:image-width" content="384">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">triangulax</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./06_self-propelled_Voronoi_model.html">Area-perimeter self-propelled Voronoi model</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">triangulax</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_trigonometry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic trigonometry</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_triangular_meshes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loading, processing, and saving triangular meshes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_coding_in_JAX_notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coding in JAX</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_halfedge_datastructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Half-edge meshes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_linear_operators_on_meshes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Adjacency-like operators on half-edge meshes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_example_simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation test case - optimize mesh to make triangles equilateral</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_self-propelled_Voronoi_model.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Area-perimeter self-propelled Voronoi model</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#read-in-test-data" id="toc-read-in-test-data" class="nav-link" data-scroll-target="#read-in-test-data">Read in test data</a></li>
  <li><a href="#voronoi-cell-geometry-area-perimeter" id="toc-voronoi-cell-geometry-area-perimeter" class="nav-link" data-scroll-target="#voronoi-cell-geometry-area-perimeter">Voronoi cell geometry (area &amp; perimeter)</a></li>
  <li><a href="#energy-relaxation-no-self-propulsion" id="toc-energy-relaxation-no-self-propulsion" class="nav-link" data-scroll-target="#energy-relaxation-no-self-propulsion">Energy relaxation (no self-propulsion)</a>
  <ul class="collapse">
  <li><a href="#relaxation-with-t1s" id="toc-relaxation-with-t1s" class="nav-link" data-scroll-target="#relaxation-with-t1s">Relaxation with T1s</a></li>
  </ul></li>
  <li><a href="#this-is-the-simulation-as-a-simple-for-loop" id="toc-this-is-the-simulation-as-a-simple-for-loop" class="nav-link" data-scroll-target="#this-is-the-simulation-as-a-simple-for-loop">this is the simulation as a simple for loop:</a>
  <ul class="collapse">
  <li><a href="#simulation-loops-with-jax.lax.scan" id="toc-simulation-loops-with-jax.lax.scan" class="nav-link" data-scroll-target="#simulation-loops-with-jax.lax.scan">Simulation loops with <code>jax.lax.scan</code></a></li>
  <li><a href="#using-a-diffrax-solver" id="toc-using-a-diffrax-solver" class="nav-link" data-scroll-target="#using-a-diffrax-solver">Using a <code>diffrax</code> solver</a></li>
  <li><a href="#overdamped-dynamics-with-self-propulsion-deterministic" id="toc-overdamped-dynamics-with-self-propulsion-deterministic" class="nav-link" data-scroll-target="#overdamped-dynamics-with-self-propulsion-deterministic">Overdamped dynamics with self-propulsion (deterministic)</a>
  <ul class="collapse">
  <li><a href="#stochastic-orientation-t1-flips-step-by-step" id="toc-stochastic-orientation-t1-flips-step-by-step" class="nav-link" data-scroll-target="#stochastic-orientation-t1-flips-step-by-step">Stochastic orientation + T1 flips (step-by-step)</a></li>
  <li><a href="#visualize-trajectory" id="toc-visualize-trajectory" class="nav-link" data-scroll-target="#visualize-trajectory">Visualize trajectory</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/nikolas-claussen/triangulax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="06_self-propelled_Voronoi_model.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Area-perimeter self-propelled Voronoi model</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>After the toy example of notebook 02, let’s try to implement a slightly more complicated model, the self-propelled Voronoi area-perimeter Voronoi (VAP) model of <a href="https://journals.aps.org/prx/abstract/10.1103/PhysRevX.6.021011">Bi et al., 2016</a>. This 2D model comprises most of the ingredients we will see in more general simulations, from a coding perspective.</p>
<p>In brief, in the VAP, cells are modeled as the Voronoi tesselation for a series of centroids <span class="math inline">\(\mathbf{v}_i\)</span> (our triangulation vertices). Their overdamped dynamics comprises two terms: self-propulsion and relaxation of an elastic energy: <span class="math display">\[\partial_t \mathbf{v}_i = -\nabla_{\mathbf{v}_i} E_{AP} + v_0 \hat{\mathbf{n}}_i\]</span> For each cell <span class="math inline">\(i\)</span>, <span class="math inline">\(\hat{\mathbf{n}}_i\)</span> is a unit vector (so we will represent it by an angle <span class="math inline">\(\theta_i\)</span>) that determines the direction of motion. Units of time are chosen so that the coefficient of <span class="math inline">\(\nabla E_{AP}\)</span> is <span class="math inline">\(1\)</span>. The energy is defined in terms of the Voronoi area <span class="math inline">\(a_i\)</span> and Voronoi perimeter <span class="math inline">\(p_i\)</span> of each cell: <span class="math display">\[E_{AP} = \sum_i k_a(a_i-a_0)^2 + k_p(p_i-p_0)^2 \]</span> where <span class="math inline">\(k_a, k_p\)</span> are elastic constants, and <span class="math inline">\(a_0, p_0\)</span> are the target area and perimeter. They define the “shape index” <span class="math inline">\(s_0= p_0/\sqrt{a_0}\)</span>. The key physics is that above a critical shape index <span class="math inline">\(s_0^*\)</span>, the model has a degenerate set of ground states, since for a large <span class="math inline">\(p_0\)</span>, there are many polygons with the given target area and perimeter (think floppy balloon).</p>
<p>The orientation <span class="math inline">\(\theta_i\)</span> of each cell is also dynamic. It undergoes rotational diffusion: <span class="math display">\[d\theta_i = D_\theta dW_{t, i} \]</span> where <span class="math inline">\(dW_{t,i}\)</span> is Brownian motion, independent for each cell <span class="math inline">\(i\)</span>, and <span class="math inline">\(D_\theta\)</span> is the diffusion constant.</p>
<section id="numerics" class="level4">
<h4 class="anchored" data-anchor-id="numerics">Numerics</h4>
<p>The cell array connectivity will be represented by a <a href="https://nikolas-claussen.github.io/triangulax/halfedge_datastructure.html#hemesh"><code>HeMesh</code></a> (see notebook 01). The geometry is fully described by the triangulation vertex positions, the Voronoi cell centroids. We also need a scalar vertex attribute for the angle <span class="math inline">\(\theta_i\)</span>.</p>
<p>To numerically calculate the energy <span class="math inline">\(E_{AP}\)</span>, we can obtain Voronoi area and perimeter for each mesh “corner” using the <code>triangulax.trigonometry</code> module. Then we can use the gather/scatter operation <code>triangulax.meshsum_he_to_vertex_opposite</code> to sum all corners belonging to a cell (see notebook 01, “Computing cell areas, perimeters, etc via corners”). Boundary cells can be handled by “mirroring”, i.e., all corners count twice when computing the area/perimeter. Given the energy, JAX autodiff gives us the gradients.</p>
<p>To time-evolve the mesh geometry, we can use <code>diffrax</code>, like in notebook 02. <code>diffrax</code> can also deal with SDEs, like the Langevin equation for cell angles. After each timestep, we need to check if the Voronoi edge lengths are below some threshold (the edge lengths can be computed on the fly), and, if so, we need to carry out edge flips. See notebook 01. We need to ensure that we do not immidiately “re-flip” an edge. This could be done, for example, via “cool down” period (an edge flipped at step <span class="math inline">\(t\)</span> cannot be flipped again for the next few steps), or by calculating if the edge is shrinking or growing.</p>
<p>It would also be great to generate some visualizations of the time evolution of the mesh using the <a href="https://nikolas-claussen.github.io/triangulax/halfedge_datastructure.html#cellplot"><code>cellplot</code></a> function, maybe with a user-controlled slider to show the different time steps.</p>
<p>The code should respect the coding style (JAX-compatibility, type hints, etc) used in previous notebooks. To start, let’s define the energy and check that relaxation of the energy leads to a state where the <span class="math inline">\(a_i=a_0\)</span> and <span class="math inline">\(p_i=p_0\)</span> constraints are fullfilled (as good as possible).</p>
<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
</section>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<div id="1d083aaf" class="cell" data-execution_count="665">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dataclasses</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Tuple</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ipywidgets <span class="im">as</span> widgets</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> functools</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> diffrax</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lineax</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jaxtyping <span class="im">import</span> Float, Bool, Int</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> IntEnum</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2c0347f1" class="cell" data-execution_count="666">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_enable_x64"</span>, <span class="va">True</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_debug_nans"</span>, <span class="va">True</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_log_compiles"</span>, <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2d5d7225" class="cell" data-execution_count="667">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> triangulax <span class="im">import</span> mesh <span class="im">as</span> msh</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> triangulax.mesh <span class="im">import</span> TriMesh, HeMesh, GeomMesh</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> triangulax <span class="im">import</span> trigonometry <span class="im">as</span> trig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b8f7383e" class="cell" data-execution_count="668">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#reload(msh)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">reload</span>(trig)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="668">
<pre><code>&lt;module 'triangulax.trigonometry' from '/Users/nc1333/Documents/Princeton/Coding/triangulax/triangulax/trigonometry.py'&gt;</code></pre>
</div>
</div>
</section>
<section id="read-in-test-data" class="level3">
<h3 class="anchored" data-anchor-id="read-in-test-data">Read in test data</h3>
<div id="68c8a57e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, vertices<span class="op">=</span>mesh.vertices)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> msh.set_voronoi_face_positions(geommesh, hemesh)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>hemesh, geommesh</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(HeMesh(N_V=131, N_HE=708, N_F=224), GeomMesh(D=2,N_V=131, N_HE=708, N_F=224))</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="669">
<pre><code>(HeMesh(N_V=131, N_HE=708, N_F=224), GeomMesh(D=2,N_V=131, N_HE=708, N_F=224))</code></pre>
</div>
</div>
<div id="43e37541" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.4</span>]),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>}))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="voronoi-cell-geometry-area-perimeter" class="level2">
<h2 class="anchored" data-anchor-id="voronoi-cell-geometry-area-perimeter">Voronoi cell geometry (area &amp; perimeter)</h2>
<p>We compute areas from corner contributions and perimeters from dual-edge lengths, using gather/scatter operations on the half-edge mesh. Boundary cells are handled by mirroring (doubling the area/perimeter).</p>
<div id="10c377f6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_triangle_area(geommesh: GeomMesh, hemesh: HeMesh) <span class="op">-&gt;</span>Float[jax.Array, <span class="st">" n_faces"</span>]:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute triangle areas."""</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> hemesh.dest[hemesh.nxt]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> hemesh.dest[hemesh.prv]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> hemesh.dest</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.vmap(trig.get_triangle_area)(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        geommesh.vertices[a], geommesh.vertices[b], geommesh.vertices[c])</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cell_area(geommesh: GeomMesh, hemesh: HeMesh) <span class="op">-&gt;</span>Float[jax.Array, <span class="st">" n_vertices"</span>]:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute Voronoi area for each cell."""</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> hemesh.dest[hemesh.nxt]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> hemesh.dest[hemesh.prv]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> hemesh.dest</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    corner_areas <span class="op">=</span> jax.vmap(trig.get_voronoi_corner_area)(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        geommesh.vertices[a], geommesh.vertices[b], geommesh.vertices[c])</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    corner_areas <span class="op">=</span> jnp.where(hemesh.is_bdry_he, <span class="dv">0</span>, corner_areas)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    cell_areas <span class="op">=</span> msh.sum_he_to_vertex_opposite(hemesh, corner_areas)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    cell_areas <span class="op">=</span> jnp.where(hemesh.is_bdry, <span class="fl">2.0</span> <span class="op">*</span> cell_areas, cell_areas)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cell_areas</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cell_perimeter(geommesh: GeomMesh, hemesh: HeMesh) <span class="op">-&gt;</span> Float[jax.Array, <span class="st">" n_vertices"</span>]:</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute Voronoi perimeters for each cell."""</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> hemesh.dest[hemesh.nxt]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> hemesh.dest[hemesh.prv]</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> hemesh.dest</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    corner_perims <span class="op">=</span> jax.vmap(trig.get_voronoi_corner_perimeter)(</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        geommesh.vertices[a], geommesh.vertices[b], geommesh.vertices[c])</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    corner_perims <span class="op">=</span> jnp.where(hemesh.is_bdry_he, <span class="dv">0</span>, corner_perims)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    cell_perims <span class="op">=</span> msh.sum_he_to_vertex_opposite(hemesh, corner_perims)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    cell_perims <span class="op">=</span> jnp.where(hemesh.is_bdry, <span class="fl">2.0</span> <span class="op">*</span> cell_perims, cell_perims)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cell_perims</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> energy_ap(geommesh: GeomMesh, hemesh: HeMesh, a0: <span class="bu">float</span>, p0: <span class="bu">float</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>              k_a: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>, k_p: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>, k_penalty: <span class="bu">float</span><span class="op">=</span><span class="dv">10</span>) <span class="op">-&gt;</span> Float[jax.Array, <span class="st">""</span>]:</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Area-perimeter energy for Voronoi cells.</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Adds small penalty for triangles with negative area.</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    cell_areas <span class="op">=</span> get_cell_area(geommesh, hemesh)    </span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    cell_perimeters <span class="op">=</span> get_cell_perimeter(geommesh, hemesh)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    tri_areas <span class="op">=</span> get_triangle_area(geommesh, hemesh)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    a_min <span class="op">=</span> <span class="fl">0.25</span><span class="op">*</span>(a0<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    penality <span class="op">=</span> k_penalty<span class="op">*</span>jnp.where(tri_areas <span class="op">&lt;</span> a_min, k_a <span class="op">*</span> (tri_areas<span class="op">-</span>a_min)<span class="op">**</span><span class="dv">2</span>, <span class="fl">0.0</span>).mean()</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.mean(k_a <span class="op">*</span> (cell_areas<span class="op">-</span>a0)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> k_p <span class="op">*</span> (cell_perimeters<span class="op">-</span>p0)<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> penality</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="25181d08" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cell_areas, cell_perimeters <span class="op">=</span> (get_cell_area(geommesh, hemesh), get_cell_perimeter(geommesh, hemesh))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>a_mean, p_mean <span class="op">=</span> (cell_areas[<span class="op">~</span>hemesh.is_bdry].mean(), cell_perimeters[<span class="op">~</span>hemesh.is_bdry].mean())</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>a_mean, p_mean, p_mean<span class="op">/</span>np.sqrt(a_mean)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="305">
<pre><code>(Array(0.02756258, dtype=float64),
 Array(0.63463959, dtype=float64),
 Array(3.82267399, dtype=float64))</code></pre>
</div>
</div>
<div id="e4267b23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>get_triangle_area(geommesh, hemesh).mean()<span class="op">*</span><span class="dv">2</span>, a_mean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="306">
<pre><code>(Array(0.02669562, dtype=float64), Array(0.02756258, dtype=float64))</code></pre>
</div>
</div>
<div id="e26f514c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># double check against "manual" area and "perimeter" computation using mesh traversal</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="energy-relaxation-no-self-propulsion" class="level2">
<h2 class="anchored" data-anchor-id="energy-relaxation-no-self-propulsion">Energy relaxation (no self-propulsion)</h2>
<p>We first relax the area–perimeter energy to verify that the constraints are satisfied.</p>
<div id="a8c29ab0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relax_energy_step(geommesh: GeomMesh, hemesh: HeMesh,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>              a0: <span class="bu">float</span>, p0: <span class="bu">float</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>              step_size: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>              k_a: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>, k_p: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>) <span class="op">-&gt;</span> Tuple[GeomMesh, Float[jax.Array, <span class="st">""</span>]]:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    loss, grad <span class="op">=</span> jax.value_and_grad(energy_ap)(geommesh, hemesh, a0, p0, k_a, k_p)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    updated_vertices <span class="op">=</span> geommesh.vertices <span class="op">-</span> step_size <span class="op">*</span> grad.vertices</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    geommesh_updated <span class="op">=</span> dataclasses.replace(geommesh, vertices<span class="op">=</span>updated_vertices)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> geommesh_updated, loss</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># energy parameters</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>a0 <span class="op">=</span> a_mean</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>s0 <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>p0 <span class="op">=</span> s0<span class="op">*</span>jnp.sqrt(a0)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co"># relaxation parameters</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>step_size <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>geommesh_relaxed <span class="op">=</span> copy.copy(geommesh)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> []</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_steps):</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    geommesh_relaxed, loss <span class="op">=</span> relax_energy_step(geommesh_relaxed, hemesh, a0, p0, step_size<span class="op">=</span>step_size)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    losses.append(loss)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> jnp.array(losses)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b1b98f9f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.plot(np.asarray(losses))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"step"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"energy"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2ad03dd6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>geommesh_relaxed <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_relaxed, hemesh)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.2</span>]),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:blue"</span>}))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh, geommesh_relaxed.face_positions,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.2</span>]),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:red"</span>}))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8017886f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>areas_relaxed, perim_relaxed <span class="op">=</span> (get_cell_area(geommesh, hemesh), get_cell_perimeter(geommesh, hemesh))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>jnp.<span class="bu">abs</span>(areas_relaxed <span class="op">-</span> a0)[hemesh.is_bdry].mean(), jnp.<span class="bu">abs</span>(perim_relaxed <span class="op">-</span> p0)[hemesh.is_bdry].mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="382">
<pre><code>(Array(0.00400013, dtype=float64), Array(0.12046733, dtype=float64))</code></pre>
</div>
</div>
<section id="relaxation-with-t1s" class="level3">
<h3 class="anchored" data-anchor-id="relaxation-with-t1s">Relaxation with T1s</h3>
<p>Next, let’s allow T1s. To ensure we don’t flip the same edge multiple times, let’s use a cooldown period.</p>
<div id="318b34d2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cooldown_steps <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>l_min_T1 <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>cooldown_counter <span class="op">=</span> jnp.zeros(hemesh.n_hes)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>sim_steps <span class="op">=</span> jnp.arange(n_steps)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="this-is-the-simulation-as-a-simple-for-loop" class="level1">
<h1>this is the simulation as a simple for loop:</h1>
<p>hemesh_relaxed = copy.copy(hemesh) geommesh_relaxed = copy.copy(geommesh) losses = [] flip_count = [] for _ in tqdm(sim_steps): # step energy geommesh_relaxed, loss = relax_energy_step(geommesh_relaxed, hemesh_relaxed, a0, p0, step_size=step_size) # compute signed edge lengths, flip, and update cooldown counter face_positions = msh.get_voronoi_face_positions(geommesh_relaxed.vertices, hemesh_relaxed) edge_lengths = msh.get_signed_dual_he_length(geommesh_relaxed.vertices, face_positions, hemesh_relaxed) to_flip = (edge_lengths &lt; l_min_T1) &amp; (cooldown_counter == 0) hemesh_relaxed = msh.flip_all(hemesh_relaxed, to_flip) cooldown_counter = jnp.where(to_flip, cooldown_steps, jnp.clip(cooldown_counter-1, 0)) losses.append(loss) flip_count.append(to_flip.sum())</p>
<p>losses = jnp.array(losses) flip_count = jnp.array(flip_count)</p>
<div id="12fd847a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># package simulation time step into a function for jax.lax.scan</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan_fun(carry: Tuple[GeomMesh,HeMesh, Int[jax.Array, <span class="st">" n_steps"</span>]], x: Float[jax.Array, <span class="st">" n_steps"</span>]):</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    geommesh_relaxed, hemesh_relaxed, cooldown_counter <span class="op">=</span> carry</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># step energy</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    geommesh_relaxed, loss <span class="op">=</span> relax_energy_step(geommesh_relaxed, hemesh_relaxed, a0, p0, step_size<span class="op">=</span>step_size)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute signed edge lengths, flip, and update cooldown counter</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    face_positions <span class="op">=</span> msh.get_voronoi_face_positions(geommesh_relaxed.vertices, hemesh_relaxed)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    edge_lengths <span class="op">=</span> msh.get_signed_dual_he_length(geommesh_relaxed.vertices, face_positions, hemesh_relaxed)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    to_flip <span class="op">=</span> (edge_lengths <span class="op">&lt;</span> l_min_T1) <span class="op">&amp;</span> (cooldown_counter <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    hemesh_relaxed <span class="op">=</span> msh.flip_all(hemesh_relaxed, to_flip)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># update cooldown counter</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    cooldown_counter <span class="op">=</span> jnp.where(to_flip, cooldown_steps, jnp.clip(cooldown_counter<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (geommesh_relaxed, hemesh_relaxed, cooldown_counter), jnp.array([loss, to_flip.<span class="bu">sum</span>()])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="652f4014" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> (geommesh, hemesh, cooldown_counter)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>(geommesh_relaxed, hemesh_relaxed, _), return_arr <span class="op">=</span> jax.lax.scan(scan_fun, init, sim_steps) </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>losses, flip_count <span class="op">=</span> return_arr.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="54ce349e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>plt.plot(losses[::<span class="bu">int</span>(n_steps<span class="op">/</span><span class="dv">1000</span>)])</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"step"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"energy"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add a twin y axis that shows the cummulative number of flips</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> plt.gca().twinx()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>ax2.plot(jnp.cumsum(flip_count)[::<span class="bu">int</span>(n_steps<span class="op">/</span><span class="dv">1000</span>)], color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"cumulative flips"</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim([<span class="dv">0</span>,flip_count.<span class="bu">sum</span>()<span class="op">+</span><span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="74980c78" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>geommesh_relaxed <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_relaxed, hemesh_relaxed)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.2</span>]),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:blue"</span>}))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh_relaxed, geommesh_relaxed.face_positions,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.2</span>]),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:red"</span>}))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e1047da1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>areas_relaxed, perim_relaxed <span class="op">=</span> (get_cell_area(geommesh, hemesh), get_cell_perimeter(geommesh, hemesh))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>jnp.<span class="bu">abs</span>(areas_relaxed <span class="op">-</span> a0)[<span class="op">~</span>hemesh.is_bdry].mean()<span class="op">/</span>a0, jnp.<span class="bu">abs</span>(perim_relaxed <span class="op">-</span> p0)[<span class="op">~</span>hemesh.is_bdry].mean()<span class="op">/</span>p0</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="388">
<pre><code>(Array(0.09045905, dtype=float64), Array(0.27422466, dtype=float64))</code></pre>
</div>
</div>
<section id="simulation-loops-with-jax.lax.scan" class="level3">
<h3 class="anchored" data-anchor-id="simulation-loops-with-jax.lax.scan">Simulation loops with <code>jax.lax.scan</code></h3>
<p>In our simulations, we generally start with an initial state (call it <code>init</code>), do a series of timesteps (via a function <code>make_step(state)</code>), and record some “measurement” at each timestep (via a <code>measure(state)</code> function). As a result, we get a timeseries of measurements, and the final simulation state. In normal python, you would do that with a <code>for</code> loop. When working with JAX, we need to <a href="https://docs.jax.dev/en/latest/control-flow.html">replace control-flow operations like <code>for</code> with their JAX pendant</a>. For for loops, this is <code>jax.lax.scan(f, init, xs)</code>, which is equivalent to the python code</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan(f, init, xs):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  carry <span class="op">=</span> init</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  ys <span class="op">=</span> []</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> x <span class="kw">in</span> xs:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    carry, y <span class="op">=</span> f(carry, x)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    ys.append(y)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> carry, np.stack(ys)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In our pattern, <code>xs</code> is the vector of time-points <code>timepoints</code>, and the “scanning-function” <code>f</code> is generally comprised of two parts, a time-step and a measurement/logging step (above, we logged energy and T1 count):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(carry, t):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    new_state <span class="op">=</span> make_step(carry, t)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    measurements <span class="op">=</span> measure(new_state)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_state, measurements</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The <code>carry</code> variable contains all information about the state of the simulation. Typically, <code>carry</code> is also composed of multiple pieces (above, the physical state <code>geommesh_relaxed, hemesh_relaxed</code>, as well as ancilliary variables like <code>cooldown_counter</code>, or the ODE solver state). In order to keep things organized, it can make sense to define dataclasses for the simulation state and the measurements, like this (schematic) example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.tree_util.register_dataclass</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimState:</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    g: msh.GeomMesh</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    h: msh.HeMesh</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    solver_state: <span class="bu">dict</span>  <span class="co"># or another PyTree</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    current_time: jax.Array</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.tree_util.register_dataclass</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Log:</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    energy: <span class="bu">float</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    T1_count: <span class="bu">int</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan_function(carry: SimState, next_time: jax.Array) <span class="op">-&gt;</span> <span class="bu">tuple</span>[SimState, Log]:</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    g, h, solver_state <span class="op">=</span> make_step(carry.g, carry.h, carry.solver_state,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                                   carry.current_time, next_time)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    log <span class="op">=</span> Log(energy<span class="op">=</span>compute_energy(g, h), area<span class="op">=</span>detect_T1s(h))</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SimState(g, h, solver_state), log</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>timepoints <span class="op">=</span> jnp.arange(t0, t1, dt)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> ... <span class="co"># define initial condition</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>final_state, measurements <span class="op">=</span> jax.lax.scan(scan_function, init, timepoints) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="using-a-diffrax-solver" class="level3">
<h3 class="anchored" data-anchor-id="using-a-diffrax-solver">Using a <code>diffrax</code> solver</h3>
<p>Note that to use, say, an adaptive time stepping algorithm, we would need to pass the current time step via the <code>carry</code> of <code>jax.lax.scan</code> to the next timestep. We would probably also like to return the timesteps taken, then.</p>
<div id="94904335" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diffrax-based relaxation step (replaces forward Euler inside the scan)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ap_vector_field(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    t: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    y: GeomMesh,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    args: Tuple[HeMesh, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>],</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> GeomMesh:</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""RHS for overdamped relaxation of area-perimeter energy."""</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    hemesh, a0, p0, k_a, k_p <span class="op">=</span> args</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    grad <span class="op">=</span> jax.grad(energy_ap)(y, hemesh, a0, p0, k_a, k_p)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jax.tree_util.tree_map(<span class="kw">lambda</span> x: <span class="op">-</span>x, grad)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>term <span class="op">=</span> diffrax.ODETerm(ap_vector_field)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> diffrax.Tsit5()</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>step_times <span class="op">=</span> dt <span class="op">*</span> jnp.arange(n_steps <span class="op">+</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a47d5926" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan_fun_diffrax(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    carry: Tuple[</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        GeomMesh,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        HeMesh,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        Float[jax.Array, <span class="st">" n_hes"</span>],</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        Float[jax.Array, <span class="st">""</span>], <span class="co"># current time</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">object</span>, <span class="co"># solver state</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    tnext: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> Tuple[</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        Tuple[</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>            GeomMesh,</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            HeMesh,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            Float[jax.Array, <span class="st">" n_hes"</span>],</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>            Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">object</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        Float[jax.Array, <span class="st">" 2"</span>],</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    ]:</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    geommesh_relaxed, hemesh_relaxed, cooldown_counter, tprev, solver_state <span class="op">=</span> carry</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> (hemesh_relaxed, a0, p0, <span class="fl">1.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    geommesh_relaxed, _, _, solver_state, _ <span class="op">=</span> solver.step(</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        term, tprev, tnext, geommesh_relaxed, args, solver_state, made_jump<span class="op">=</span><span class="va">False</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> energy_ap(geommesh_relaxed, hemesh_relaxed, a0, p0)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    face_positions <span class="op">=</span> msh.get_voronoi_face_positions(geommesh_relaxed.vertices, hemesh_relaxed)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    edge_lengths <span class="op">=</span> msh.get_signed_dual_he_length(geommesh_relaxed.vertices, face_positions, hemesh_relaxed)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    to_flip <span class="op">=</span> (edge_lengths <span class="op">&lt;</span> l_min_T1) <span class="op">&amp;</span> (cooldown_counter <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    hemesh_relaxed <span class="op">=</span> msh.flip_all(hemesh_relaxed, to_flip)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    cooldown_counter <span class="op">=</span> jnp.where(to_flip, cooldown_steps, jnp.clip(cooldown_counter <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (geommesh_relaxed, hemesh_relaxed, cooldown_counter, tnext, solver_state), jnp.array([loss, to_flip.<span class="bu">sum</span>()])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3873937a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>init_solver_state <span class="op">=</span> solver.init(term, step_times[<span class="dv">0</span>], step_times[<span class="dv">1</span>], geommesh, (hemesh, a0, p0, <span class="fl">1.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> (geommesh, hemesh, cooldown_counter, step_times[<span class="dv">0</span>], init_solver_state)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="de54c2e0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(geommesh_relaxed, hemesh_relaxed, _, _, _), return_arr <span class="op">=</span> jax.lax.scan(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    scan_fun_diffrax, init, step_times[<span class="dv">1</span>:])</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>losses, flip_count <span class="op">=</span> return_arr.T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="293d0ae3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>plt.plot(losses[::<span class="bu">int</span>(n_steps<span class="op">/</span><span class="dv">1000</span>)])</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"step"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"energy"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> plt.gca().twinx()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>ax2.plot(jnp.cumsum(flip_count)[::<span class="bu">int</span>(n_steps<span class="op">/</span><span class="dv">1000</span>)], color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"cumulative flips"</span>, color<span class="op">=</span><span class="st">"orange"</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim([<span class="dv">0</span>, flip_count.<span class="bu">sum</span>() <span class="op">+</span> <span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e58e45cc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>geommesh_relaxed <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_relaxed, hemesh_relaxed)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.2</span>]),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:blue"</span>}))</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh_relaxed, geommesh_relaxed.face_positions,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.2</span>]),</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:red"</span>}))</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="overdamped-dynamics-with-self-propulsion-deterministic" class="level2">
<h2 class="anchored" data-anchor-id="overdamped-dynamics-with-self-propulsion-deterministic">Overdamped dynamics with self-propulsion (deterministic)</h2>
<p>Next, let’s add the self-propulsion term. We initialize the angles <span class="math inline">\(\theta_i\)</span> at random. We can store the angles as an extra <code>vertex_attrib</code> in our <code>geommesh</code>, using the functionality of the <a href="https://nikolas-claussen.github.io/triangulax/halfedge_datastructure.html#geommesh"><code>GeomMesh</code></a> dataclass. We already have an <code>IntEnum</code> which we can use as keys to the <code>vertex_attrib</code> dictionary, like described in notebook 01.</p>
<p>As a first step, we can keep the orientations fixed and just integrate <span class="math inline">\(\partial_t \mathbf{v}_i = -\nabla_{\mathbf{v}_i} E_{AP} + v_0\hat{\mathbf{n}}_i\)</span>, like in the above example. We only simulate for a couple of steps.</p>
<div id="0a4ba227" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VertexAttribs(IntEnum):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    SELF_PROPULSION_ORIENTATION <span class="op">=</span> <span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bec047ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>jax.config.update(<span class="st">"jax_disable_jit"</span>, <span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c65042dc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize orientations and store as a vertex attribute</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> jax.random.key(<span class="dv">0</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>theta0 <span class="op">=</span> jax.random.uniform(key, shape<span class="op">=</span>(hemesh.n_vertices,), minval<span class="op">=</span><span class="fl">0.0</span>, maxval<span class="op">=</span><span class="dv">2</span><span class="op">*</span>jnp.pi)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">#theta0 = theta0 + 0.3 * 2*jnp.pi*jnp.ones(hemesh.n_vertices)</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>geommesh_sp <span class="op">=</span> copy.copy(geommesh)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>geommesh_sp <span class="op">=</span> dataclasses.replace(</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    geommesh_sp,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    vertex_attribs<span class="op">=</span>{VertexAttribs.SELF_PROPULSION_ORIENTATION: theta0},</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ap_selfprop_vector_field(</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    t: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    y: GeomMesh,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    args: Tuple[HeMesh, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>, <span class="bu">float</span>],</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> GeomMesh:</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""RHS for overdamped area-perimeter dynamics with self-propulsion."""</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    hemesh, a0, p0, v0, k_a, k_p <span class="op">=</span> args</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> y.vertex_attribs[VertexAttribs.SELF_PROPULSION_ORIENTATION]</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    grad <span class="op">=</span> jax.grad(energy_ap)(y, hemesh, a0, p0, k_a, k_p)</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    n_hat <span class="op">=</span> jnp.stack([jnp.cos(theta), jnp.sin(theta)], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    velocity <span class="op">=</span> <span class="op">-</span>grad.vertices <span class="op">+</span> jnp.where(hemesh.is_bdry[:,<span class="va">None</span>], <span class="dv">0</span>, v0 <span class="op">*</span> n_hat)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    zero_vertex_attribs <span class="op">=</span> {key: jnp.zeros_like(val) <span class="cf">for</span> key, val <span class="kw">in</span> y.vertex_attribs.items()}</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataclasses.replace(</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        y,</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        vertices<span class="op">=</span>velocity,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        vertex_attribs<span class="op">=</span>zero_vertex_attribs,</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>term_sp <span class="op">=</span> diffrax.ODETerm(ap_selfprop_vector_field)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>solver_sp <span class="op">=</span> diffrax.Euler() <span class="co">#Tsit5</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>dt_sp <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>n_steps_sp <span class="op">=</span> <span class="dv">20000</span> <span class="co"># begins to fail at some point</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>v0_sp <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>step_times_sp <span class="op">=</span> dt_sp <span class="op">*</span> jnp.arange(n_steps_sp <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>cooldown_steps <span class="op">=</span> <span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ef2d2f7b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check magnitude of the gradient forces vs the self-propulsion </span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>grad0 <span class="op">=</span> jax.grad(energy_ap)(geommesh_sp, hemesh, a0, p0, <span class="dv">1</span>, <span class="dv">1</span>).vertices</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>sp0 <span class="op">=</span> v0_sp<span class="op">*</span>jnp.stack([jnp.cos(theta0), jnp.sin(theta0)], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>jnp.linalg.norm(sp0, axis<span class="op">=-</span><span class="dv">1</span>).mean() <span class="op">/</span> jnp.linalg.norm(grad0, axis<span class="op">=-</span><span class="dv">1</span>).mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="557">
<pre><code>Array(0.31473995, dtype=float64)</code></pre>
</div>
</div>
<div id="4d0c5dbd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan_fun_selfprop(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    carry: Tuple[GeomMesh,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                 HeMesh,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                 Float[jax.Array, <span class="st">" n_hes"</span>],</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                 Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                 <span class="bu">object</span>,],</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    tnext: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    Tuple[GeomMesh,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>          HeMesh,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>          Float[jax.Array, <span class="st">" n_hes"</span>],</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>          Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>          <span class="bu">object</span>,],</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    GeomMesh]:</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    geommesh_curr, hemesh_curr, cooldown_counter, tprev, solver_state <span class="op">=</span> carry</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> (hemesh_curr, a0, p0, v0_sp, <span class="fl">1.0</span>, <span class="fl">1.0</span>)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    geommesh_next, _, _, solver_state, _ <span class="op">=</span> solver_sp.step(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        term_sp, tprev, tnext, geommesh_curr, args, solver_state, made_jump<span class="op">=</span><span class="va">False</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    face_positions <span class="op">=</span> msh.get_voronoi_face_positions(geommesh_next.vertices, hemesh_curr)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    edge_lengths <span class="op">=</span> msh.get_signed_dual_he_length(geommesh_next.vertices, face_positions, hemesh_curr)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    to_flip <span class="op">=</span> (edge_lengths <span class="op">&lt;</span> l_min_T1) <span class="op">&amp;</span> (cooldown_counter <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    hemesh_next <span class="op">=</span> msh.flip_all(hemesh_curr, to_flip)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    cooldown_counter <span class="op">=</span> jnp.where(to_flip, cooldown_steps, jnp.clip(cooldown_counter <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (geommesh_next, hemesh_next, cooldown_counter, tnext, solver_state), geommesh_next</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8cf6019c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>cooldown_counter_sp <span class="op">=</span> jnp.zeros(hemesh.n_hes)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>init_solver_state_sp <span class="op">=</span> solver_sp.init(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    term_sp, step_times_sp[<span class="dv">0</span>], step_times_sp[<span class="dv">1</span>], geommesh_sp, (hemesh, a0, p0, v0_sp, <span class="fl">1.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> (geommesh_sp, hemesh, cooldown_counter_sp, step_times_sp[<span class="dv">0</span>], init_solver_state_sp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fd706958" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(geommesh_final, hemesh_final, cooldown, _, _), traj <span class="op">=</span> jax.lax.scan(scan_fun_selfprop, init, step_times_sp[<span class="dv">1</span>:])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b81f9e9b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unpack the trajectory</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>traj <span class="op">=</span> msh.tree_unstack(traj)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(traj)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="561">
<pre><code>20000</code></pre>
</div>
</div>
<div id="62e0639a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>geommesh_sp <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_sp, hemesh)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>geommesh_final <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_final, hemesh_final)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>areas <span class="op">=</span> get_cell_area(geommesh_final, hemesh_final)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>edge_lengths <span class="op">=</span> msh.get_signed_dual_he_length(geommesh_final.vertices, geommesh_final.face_positions, hemesh_final)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="be790214" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>edge_lengths.<span class="bu">min</span>(), areas.<span class="bu">min</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="563">
<pre><code>(Array(0.01135076, dtype=float64), Array(0.01023393, dtype=float64))</code></pre>
</div>
</div>
<div id="b4bd2424" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.triplot(*geommesh_sp.vertices.T, hemesh.faces)</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>geommesh_final.vertices.T, hemesh_final.faces)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.scatter(*geommesh_final.vertices.T, c=areas, cmap="viridis", s=20, vmin=0)</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">#ax.add_collection(msh.cellplot(hemesh, geommesh_sp.face_positions,</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                               cell_colors=np.array([0.7, 0.7, 0.9, 0.2]),</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                               mpl_polygon_kwargs={"lw": 0.5, "ec": "tab:blue"}))</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh_final, geommesh_final.face_positions,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.2</span>]),</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:red"</span>}))</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="stochastic-orientation-t1-flips-step-by-step" class="level3">
<h3 class="anchored" data-anchor-id="stochastic-orientation-t1-flips-step-by-step">Stochastic orientation + T1 flips (step-by-step)</h3>
<p>We now include rotational diffusion for <span class="math inline">\(\theta_i\)</span> and perform edge flips when Voronoi dual edges fall below a threshold. Like before, a short cooldown avoids immediate re-flips. We can use <code>diffrax</code> to solve the stochastic differential equation for the orientations, like in <a href="https://docs.kidger.site/diffrax/usage/getting-started/#stochastic-differential-equations-sdes">this tutorial</a>. Let’s also implement the “pattern” for simulation loops with <code>jax.lax.scan</code>. We need to make sure that the timestepping for the SDE and the relaxational dynamics for the vertices is consistent.</p>
<p>Note that the simulation generally diverges if the self-propulsion term is too strong, due to effects at the boundaries. A more carefull handling of the boundaries (adding T1s on the boundaries, or using periodic BCs) is beyond the scope of this notebook.</p>
<div id="2a3bee7b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># minimal example for solving an SDE, from diffrax tutorial</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>t0, t1 <span class="op">=</span> <span class="dv">0</span>, <span class="dv">3</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>y0 <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> <span class="va">None</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>drift <span class="op">=</span> <span class="kw">lambda</span> t, y, args: <span class="op">-</span>y</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>diffusion <span class="op">=</span> <span class="kw">lambda</span> t, y, args: <span class="fl">0.1</span> <span class="op">*</span> t</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>brownian_motion <span class="op">=</span>  diffrax.VirtualBrownianTree(t0, t1, tol<span class="op">=</span><span class="fl">1e-3</span>, shape<span class="op">=</span>(), key<span class="op">=</span>jax.random.PRNGKey(<span class="dv">0</span>))</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>terms <span class="op">=</span> diffrax.MultiTerm(diffrax.ODETerm(drift),  diffrax.ControlTerm(diffusion, brownian_motion))</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>solver <span class="op">=</span> diffrax.Euler()</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>saveat <span class="op">=</span> diffrax.SaveAt(dense<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5cadb661" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> diffrax.diffeqsolve(terms, solver, t0, t1, dt0<span class="op">=</span>dt, y0<span class="op">=</span>y0, saveat<span class="op">=</span>saveat)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sol.evaluate(<span class="fl">1.1</span>))  <span class="co"># DeviceArray(0.89436394)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.27087012958157025</code></pre>
</div>
</div>
<div id="c0910af2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stepping thru the solve one-by-one</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> solver.init(terms, t0, t0<span class="op">+</span>dt, y0, args)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sde_step():</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> solver.step(terms, t0, t0<span class="op">+</span>dt, y0, args, state, made_jump<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> sde_step()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="099013f5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># handling of theta_term is not ideal yet, should be passed somehow as a argument.</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># maybe we should use equinox for this, so we can still JIT-compile.</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_t1_flips(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    geommesh: GeomMesh,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    hemesh: HeMesh,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    cooldown_counter: Int[jax.Array, <span class="st">" n_hes"</span>],</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    l_min_T1: <span class="bu">float</span>,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    cooldown_steps: <span class="bu">int</span>,) <span class="op">-&gt;</span> Tuple[HeMesh, Int[jax.Array, <span class="st">" n_hes"</span>], Bool[jax.Array, <span class="st">" n_hes"</span>],]:</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply T1 flips with a per-edge cooldown."""</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    face_positions <span class="op">=</span> msh.get_voronoi_face_positions(geommesh.vertices, hemesh)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    edge_lengths <span class="op">=</span> msh.get_signed_dual_he_length(geommesh.vertices, face_positions, hemesh)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    to_flip <span class="op">=</span> (edge_lengths <span class="op">&lt;</span> l_min_T1) <span class="op">&amp;</span> (cooldown_counter <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    hemesh_next <span class="op">=</span> msh.flip_all(hemesh, to_flip)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    cooldown_counter <span class="op">=</span> jnp.where(</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        to_flip,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        cooldown_steps,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        jnp.clip(cooldown_counter <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>),)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hemesh_next, cooldown_counter, to_flip</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> theta_drift(</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    t: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    theta: Float[jax.Array, <span class="st">" n_vertices"</span>],</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    args: Float[jax.Array, <span class="st">""</span>],) <span class="op">-&gt;</span> Float[jax.Array, <span class="st">" n_vertices"</span>]:</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Drift for orientation angles (zero drift)."""</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.zeros_like(theta)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> theta_diffusion(</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    t: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    theta: Float[jax.Array, <span class="st">" n_vertices"</span>],</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    args: Float[jax.Array, <span class="st">""</span>],) <span class="op">-&gt;</span> lineax.AbstractLinearOperator:</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Diffusion operator for orientations (diagonal noise)."""</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    d_theta <span class="op">=</span> args</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    diagonal <span class="op">=</span> d_theta <span class="op">*</span> jnp.ones_like(theta)</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lineax.DiagonalLinearOperator(diagonal)</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>theta_solver <span class="op">=</span> diffrax.EulerHeun()</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>d_theta: Float[jax.Array, <span class="st">""</span>] <span class="op">=</span> jnp.asarray(<span class="fl">0.5</span>)</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> step_theta_sde(</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>    theta: Float[jax.Array, <span class="st">" n_vertices"</span>],</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>    tprev: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>    tnext: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>    d_theta: Float[jax.Array, <span class="st">""</span>],</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>    theta_solver_state: <span class="bu">object</span>,) <span class="op">-&gt;</span> Tuple[Float[jax.Array, <span class="st">" n_vertices"</span>], <span class="bu">object</span>,]:</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Single SDE step for orientations using diffrax (step-based)."""</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>    theta_next, _, _, theta_solver_state, _ <span class="op">=</span> theta_solver.step(</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>        theta_term,</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        tprev,</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>        tnext,</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>        theta,</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>        d_theta,</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>        theta_solver_state,</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>        made_jump<span class="op">=</span><span class="va">False</span>,)</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> theta_next, theta_solver_state</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.tree_util.register_dataclass</span></span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclasses.dataclass</span></span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SDEState:</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>    geommesh: GeomMesh</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>    hemesh: HeMesh</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>    cooldown_counter: Int[jax.Array, <span class="st">" n_hes"</span>]</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>    tprev: Float[jax.Array, <span class="st">""</span>]</span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>    solver_state: <span class="bu">object</span></span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>    theta: Float[jax.Array, <span class="st">" n_vertices"</span>]</span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>    theta_solver_state: <span class="bu">object</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.tree_util.register_dataclass</span></span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclasses.dataclass</span></span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SDELog:</span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>    geommesh: GeomMesh</span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a>    hemesh: HeMesh</span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>    energy: Float[jax.Array, <span class="st">""</span>]</span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    t1_count: Int[jax.Array, <span class="st">""</span>]</span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>v0_sp <span class="op">=</span> <span class="fl">0.005</span></span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a><span class="at">@jax.jit</span></span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scan_fun_selfprop_sde(</span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>    state: SDEState,</span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>    tnext: Float[jax.Array, <span class="st">""</span>],) <span class="op">-&gt;</span> <span class="bu">tuple</span>[SDEState, SDELog]:</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># time-step SDE for self-propulsion orientation</span></span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>    theta_next, theta_solver_state <span class="op">=</span> step_theta_sde(</span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>        state.theta,</span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>        state.tprev,</span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>        tnext,</span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>        d_theta,</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>        state.theta_solver_state,)</span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>    geommesh_curr <span class="op">=</span> dataclasses.replace(</span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a>        state.geommesh,</span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>        vertex_attribs<span class="op">=</span>{VertexAttribs.SELF_PROPULSION_ORIENTATION: theta_next,},)</span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> (state.hemesh, a0, p0, v0_sp, <span class="fl">1.0</span>, <span class="fl">1.0</span>,)</span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># relaxational dynamics for vertices</span></span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>    geommesh_next, _, _, solver_state, _ <span class="op">=</span> solver_sp.step(</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>        term_sp,</span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a>        state.tprev,</span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>        tnext,</span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a>        geommesh_curr,</span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true" tabindex="-1"></a>        args,</span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true" tabindex="-1"></a>        state.solver_state,</span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true" tabindex="-1"></a>        made_jump<span class="op">=</span><span class="va">False</span>,)</span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># T1 transitions for connectivity</span></span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true" tabindex="-1"></a>    hemesh_next, cooldown_counter, to_flip <span class="op">=</span> apply_t1_flips(</span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true" tabindex="-1"></a>        geommesh_next,</span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true" tabindex="-1"></a>        state.hemesh,</span>
<span id="cb57-115"><a href="#cb57-115" aria-hidden="true" tabindex="-1"></a>        state.cooldown_counter,</span>
<span id="cb57-116"><a href="#cb57-116" aria-hidden="true" tabindex="-1"></a>        l_min_T1,</span>
<span id="cb57-117"><a href="#cb57-117" aria-hidden="true" tabindex="-1"></a>        cooldown_steps,)</span>
<span id="cb57-118"><a href="#cb57-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make measurements for log</span></span>
<span id="cb57-119"><a href="#cb57-119" aria-hidden="true" tabindex="-1"></a>    energy <span class="op">=</span> energy_ap(geommesh_next, hemesh_next, a0, p0)</span>
<span id="cb57-120"><a href="#cb57-120" aria-hidden="true" tabindex="-1"></a>    log <span class="op">=</span> SDELog(</span>
<span id="cb57-121"><a href="#cb57-121" aria-hidden="true" tabindex="-1"></a>        geommesh<span class="op">=</span>geommesh_next,</span>
<span id="cb57-122"><a href="#cb57-122" aria-hidden="true" tabindex="-1"></a>        hemesh<span class="op">=</span>hemesh_next,</span>
<span id="cb57-123"><a href="#cb57-123" aria-hidden="true" tabindex="-1"></a>        energy<span class="op">=</span>energy,</span>
<span id="cb57-124"><a href="#cb57-124" aria-hidden="true" tabindex="-1"></a>        t1_count<span class="op">=</span>to_flip.<span class="bu">sum</span>(),)</span>
<span id="cb57-125"><a href="#cb57-125" aria-hidden="true" tabindex="-1"></a>    next_state <span class="op">=</span> SDEState(</span>
<span id="cb57-126"><a href="#cb57-126" aria-hidden="true" tabindex="-1"></a>        geommesh<span class="op">=</span>geommesh_next,</span>
<span id="cb57-127"><a href="#cb57-127" aria-hidden="true" tabindex="-1"></a>        hemesh<span class="op">=</span>hemesh_next,</span>
<span id="cb57-128"><a href="#cb57-128" aria-hidden="true" tabindex="-1"></a>        cooldown_counter<span class="op">=</span>cooldown_counter,</span>
<span id="cb57-129"><a href="#cb57-129" aria-hidden="true" tabindex="-1"></a>        tprev<span class="op">=</span>tnext,</span>
<span id="cb57-130"><a href="#cb57-130" aria-hidden="true" tabindex="-1"></a>        solver_state<span class="op">=</span>solver_state,</span>
<span id="cb57-131"><a href="#cb57-131" aria-hidden="true" tabindex="-1"></a>        theta<span class="op">=</span>theta_next,</span>
<span id="cb57-132"><a href="#cb57-132" aria-hidden="true" tabindex="-1"></a>        theta_solver_state<span class="op">=</span>theta_solver_state,)</span>
<span id="cb57-133"><a href="#cb57-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> next_state, log</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="88081591" class="cell" data-execution_count="683">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>brownian.t0, brownian.t1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="683">
<pre><code>(Array(0., dtype=float64, weak_type=True),
 Array(150.01, dtype=float64, weak_type=True))</code></pre>
</div>
</div>
<div id="ee1f54b3" class="cell" data-execution_count="686">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>dt_sde <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>n_steps_sde <span class="op">=</span> <span class="dv">8000</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>step_times_sde <span class="op">=</span> dt_sde <span class="op">*</span> jnp.arange(n_steps_sde <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>cooldown_counter_sde <span class="op">=</span> jnp.zeros(hemesh.n_hes, dtype<span class="op">=</span>jnp.int32)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>theta_init <span class="op">=</span> geommesh_sp.vertex_attribs[VertexAttribs.SELF_PROPULSION_ORIENTATION]</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>key_sde <span class="op">=</span> jax.random.key(<span class="dv">1</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>init_solver_state_sde <span class="op">=</span> solver_sp.init(</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    term_sp,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">0</span>],</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">1</span>],</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    geommesh_sp,</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    (hemesh, a0, p0, v0_sp, <span class="fl">1.0</span>, <span class="fl">1.0</span>,),)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>brownian <span class="op">=</span> diffrax.VirtualBrownianTree(</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">0</span>],</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> dt_sde,</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    tol<span class="op">=</span><span class="fl">1e-3</span>,</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    shape<span class="op">=</span>theta_init.shape,</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span>key_sde,)</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>theta_term <span class="op">=</span> diffrax.MultiTerm(</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>    diffrax.ODETerm(theta_drift),</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    diffrax.ControlTerm(theta_diffusion, brownian),)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>theta_solver_state <span class="op">=</span> theta_solver.init(</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    theta_term,</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">0</span>],</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">1</span>],</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>    theta_init,</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>    d_theta,)</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>init_sde <span class="op">=</span> SDEState(</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    geommesh<span class="op">=</span>geommesh_sp,</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>    hemesh<span class="op">=</span>hemesh,</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>    cooldown_counter<span class="op">=</span>cooldown_counter_sde,</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>    tprev<span class="op">=</span>step_times_sde[<span class="dv">0</span>],</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>    solver_state<span class="op">=</span>init_solver_state_sde,</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    theta<span class="op">=</span>theta_init,</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>    theta_solver_state<span class="op">=</span>theta_solver_state,)</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Time stepping: scan advances (tprev -&gt; tnext) for both theta and vertex dynamics.</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>final_state_sde, logs_sde <span class="op">=</span> jax.lax.scan(</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>    scan_fun_selfprop_sde,</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>    init_sde,</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>    step_times_sde[<span class="dv">1</span>:],)</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>geommesh_final_sde <span class="op">=</span> final_state_sde.geommesh</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>hemesh_final_sde <span class="op">=</span> final_state_sde.hemesh</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>theta_final_sde <span class="op">=</span> final_state_sde.theta</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Measurements logged at each step: geometry, energy, and T1 flip counts.</span></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>geommesh_traj_sde <span class="op">=</span> msh.tree_unstack(logs_sde.geommesh)</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>hemesh_traj_sde <span class="op">=</span> msh.tree_unstack(logs_sde.hemesh)</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>flip_counts_sde <span class="op">=</span> logs_sde.t1_count</span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>energies_sde <span class="op">=</span> logs_sde.energy</span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>traj_sde <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(geommesh_traj_sde, hemesh_traj_sde,))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="visualize-trajectory" class="level3">
<h3 class="anchored" data-anchor-id="visualize-trajectory">Visualize trajectory</h3>
<p>Let’s add an <code>ipywidget</code>-based slider plot that allows us to visualize the trajectory of the mesh’s time evolution.</p>
<div id="ab353313" class="cell" data-execution_count="687">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>np.linalg.norm(geommesh_traj_sde[<span class="dv">0</span>].vertices<span class="op">-</span>geommesh_traj_sde[<span class="op">-</span><span class="dv">1</span>].vertices, axis<span class="op">=-</span><span class="dv">1</span>).mean() <span class="co"># avg displacement</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="687">
<pre><code>np.float64(0.10620549370268782)</code></pre>
</div>
</div>
<div id="2480efe8" class="cell" data-execution_count="688">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>plt.plot(jnp.cumsum(flip_counts_sde))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="fac23eb8" class="cell" data-execution_count="689">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>cell_id <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>plt.plot(logs_sde.geommesh.vertex_attribs[VertexAttribs.SELF_PROPULSION_ORIENTATION][:, cell_id])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0c274405" class="cell" data-execution_count="690">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>plt.plot(energies_sde)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-48-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5d0e169f" class="cell" data-execution_count="677">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>msh.set_voronoi_face_positions(geommesh_traj_sde[<span class="op">-</span><span class="dv">1</span>], hemesh_traj_sde[<span class="op">-</span><span class="dv">1</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="677">
<pre><code>GeomMesh(D=2,N_V=131, N_HE=708, N_F=224)</code></pre>
</div>
</div>
<div id="cc1fb630" class="cell" data-execution_count="692">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.triplot(*geommesh_traj_sde[0].vertices.T, hemesh_traj_sde[0].faces)</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.triplot(*geommesh_traj_sde[-1].vertices.T, hemesh_traj_sde[-1].faces)</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.scatter(*geommesh_final.vertices.T, c=areas, cmap="viridis", s=20, vmin=0)</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>geommesh_traj_sde[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> msh.set_voronoi_face_positions(geommesh_traj_sde[<span class="op">-</span><span class="dv">1</span>], hemesh_traj_sde[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh_traj_sde[<span class="dv">0</span>], geommesh_traj_sde[<span class="dv">0</span>].face_positions,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.2</span>]),</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:blue"</span>}))</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>ax.add_collection(msh.cellplot(hemesh_traj_sde[<span class="op">-</span><span class="dv">1</span>], geommesh_traj_sde[<span class="op">-</span><span class="dv">1</span>].face_positions,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                               cell_colors<span class="op">=</span>np.array([<span class="fl">0.9</span>, <span class="fl">0.6</span>, <span class="fl">0.6</span>, <span class="fl">0.2</span>]),</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>                               mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"tab:red"</span>}))</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_self-propelled_Voronoi_model_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6d88c5db" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_traj_step(step_idx: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    geommesh_i, hemesh_i <span class="op">=</span> traj_sde[step_idx]</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    face_positions <span class="op">=</span> msh.get_voronoi_face_positions(geommesh_i.vertices, hemesh_i)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    ax.add_collection(</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        msh.cellplot(</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>            hemesh_i,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>            face_positions,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>            cell_colors<span class="op">=</span>np.array([<span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">0.9</span>, <span class="fl">0.25</span>]),</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>            mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="fl">0.5</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>},</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    ax.autoscale_view()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5ab2b0d0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>widgets.interact(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    plot_traj_step,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    step_idx<span class="op">=</span>widgets.IntSlider(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">min</span><span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span><span class="op">=</span><span class="bu">len</span>(traj_sde) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        step<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        continuous_update<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0316ad216b8448a7851108a47bcc7d45","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="486">
<pre><code>&lt;function __main__.plot_traj_step(step_idx: int) -&gt; None&gt;</code></pre>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nikolas-claussen\.github\.io\/triangulax");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nikolas-claussen/triangulax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>