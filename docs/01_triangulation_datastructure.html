<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>triangulation_datastructure – triangulax</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f245066ca199b7326ac6b360085ddf3a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="triangulax">
<meta property="og:description" content="JAX-compatible triangular meshes and triangular-mesh-based simulations">
<meta property="og:image" content="https://nikolas-claussen.github.io/triangulax/01_triangulation_datastructure_files/figure-html/cell-9-output-2.png">
<meta property="og:site_name" content="triangulax">
<meta property="og:image:height" content="413">
<meta property="og:image:width" content="559">
<meta name="twitter:title" content="triangulax">
<meta name="twitter:description" content="JAX-compatible triangular meshes and triangular-mesh-based simulations">
<meta name="twitter:image" content="https://nikolas-claussen.github.io/triangulax/01_triangulation_datastructure_files/figure-html/cell-9-output-2.png">
<meta name="twitter:image-height" content="413">
<meta name="twitter:image-width" content="559">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">triangulax</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_triangulation_datastructure.html">JAX-compatible data structure triangulations</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">triangulax</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_trigonometry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic trigonometry</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_triangulation_datastructure.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">JAX-compatible data structure triangulations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_test_simulations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Simulation test case - optimize mesh to make triangles equilateral</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_area_perimeter_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Area-perimeter self-propelled Voronoi model</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#jax-compatible-data-structure-triangulations" id="toc-jax-compatible-data-structure-triangulations" class="nav-link active" data-scroll-target="#jax-compatible-data-structure-triangulations">JAX-compatible data structure triangulations</a>
  <ul class="collapse">
  <li><a href="#coding-style-notes" id="toc-coding-style-notes" class="nav-link" data-scroll-target="#coding-style-notes">Coding style notes</a></li>
  <li><a href="#jax" id="toc-jax" class="nav-link" data-scroll-target="#jax">JAX</a></li>
  <li><a href="#triangular-mesh-datastructure" id="toc-triangular-mesh-datastructure" class="nav-link" data-scroll-target="#triangular-mesh-datastructure">Triangular mesh datastructure</a></li>
  <li><a href="#trimesh" id="toc-trimesh" class="nav-link" data-scroll-target="#trimesh">TriMesh</a></li>
  <li><a href="#creating-meshes-and-plotting" id="toc-creating-meshes-and-plotting" class="nav-link" data-scroll-target="#creating-meshes-and-plotting">Creating meshes and plotting</a></li>
  <li><a href="#generate_triangular_lattice" id="toc-generate_triangular_lattice" class="nav-link" data-scroll-target="#generate_triangular_lattice">generate_triangular_lattice</a></li>
  <li><a href="#generate_poisson_points" id="toc-generate_poisson_points" class="nav-link" data-scroll-target="#generate_poisson_points">generate_poisson_points</a></li>
  <li><a href="#generate_ginibre_points" id="toc-generate_ginibre_points" class="nav-link" data-scroll-target="#generate_ginibre_points">generate_ginibre_points</a></li>
  <li><a href="#elementary-book-keeping-using-list-of-triangles-data-structure" id="toc-elementary-book-keeping-using-list-of-triangles-data-structure" class="nav-link" data-scroll-target="#elementary-book-keeping-using-list-of-triangles-data-structure">Elementary book-keeping using list-of-triangles data structure</a></li>
  <li><a href="#get_adjacent_vertex_indices" id="toc-get_adjacent_vertex_indices" class="nav-link" data-scroll-target="#get_adjacent_vertex_indices">get_adjacent_vertex_indices</a></li>
  </ul></li>
  <li><a href="#half-edge-meshes" id="toc-half-edge-meshes" class="nav-link" data-scroll-target="#half-edge-meshes">Half-edge meshes</a>
  <ul class="collapse">
  <li><a href="#label_plot" id="toc-label_plot" class="nav-link" data-scroll-target="#label_plot">label_plot</a></li>
  <li><a href="#get_half_edge_arrays" id="toc-get_half_edge_arrays" class="nav-link" data-scroll-target="#get_half_edge_arrays">get_half_edge_arrays</a></li>
  <li><a href="#jax-compatibility" id="toc-jax-compatibility" class="nav-link" data-scroll-target="#jax-compatibility">JAX compatibility</a></li>
  <li><a href="#hemesh" id="toc-hemesh" class="nav-link" data-scroll-target="#hemesh">HeMesh</a></li>
  <li><a href="#boundary-and-the-vertex-at-infinity" id="toc-boundary-and-the-vertex-at-infinity" class="nav-link" data-scroll-target="#boundary-and-the-vertex-at-infinity">Boundary and the vertex at infinity</a></li>
  <li><a href="#connect_boundary_to_infinity" id="toc-connect_boundary_to_infinity" class="nav-link" data-scroll-target="#connect_boundary_to_infinity">connect_boundary_to_infinity</a></li>
  </ul></li>
  <li><a href="#mesh-geometry-and-per-mesh-variables" id="toc-mesh-geometry-and-per-mesh-variables" class="nav-link" data-scroll-target="#mesh-geometry-and-per-mesh-variables">Mesh geometry and per-mesh variables</a>
  <ul class="collapse">
  <li><a href="#vertex-half-edge-and-face-properties" id="toc-vertex-half-edge-and-face-properties" class="nav-link" data-scroll-target="#vertex-half-edge-and-face-properties">Vertex, half-edge, and face properties</a></li>
  <li><a href="#faceattribs" id="toc-faceattribs" class="nav-link" data-scroll-target="#faceattribs">FaceAttribs</a></li>
  <li><a href="#heattribs" id="toc-heattribs" class="nav-link" data-scroll-target="#heattribs">HeAttribs</a></li>
  <li><a href="#vertexattribs" id="toc-vertexattribs" class="nav-link" data-scroll-target="#vertexattribs">VertexAttribs</a></li>
  <li><a href="#geommesh" id="toc-geommesh" class="nav-link" data-scroll-target="#geommesh">GeomMesh</a></li>
  <li><a href="#set_voronoi_face_positions" id="toc-set_voronoi_face_positions" class="nav-link" data-scroll-target="#set_voronoi_face_positions">set_voronoi_face_positions</a></li>
  <li><a href="#get_voronoi_face_positions" id="toc-get_voronoi_face_positions" class="nav-link" data-scroll-target="#get_voronoi_face_positions">get_voronoi_face_positions</a></li>
  <li><a href="#mesh" id="toc-mesh" class="nav-link" data-scroll-target="#mesh">Mesh</a></li>
  <li><a href="#cellplot" id="toc-cellplot" class="nav-link" data-scroll-target="#cellplot">cellplot</a></li>
  <li><a href="#adding-some-vertexhalf-edgeface-properties" id="toc-adding-some-vertexhalf-edgeface-properties" class="nav-link" data-scroll-target="#adding-some-vertexhalf-edgeface-properties">Adding some vertex/half-edge/face properties</a></li>
  </ul></li>
  <li><a href="#batching" id="toc-batching" class="nav-link" data-scroll-target="#batching">Batching</a>
  <ul class="collapse">
  <li><a href="#tree_unstack" id="toc-tree_unstack" class="nav-link" data-scroll-target="#tree_unstack">tree_unstack</a></li>
  <li><a href="#tree_stack" id="toc-tree_stack" class="nav-link" data-scroll-target="#tree_stack">tree_stack</a></li>
  </ul></li>
  <li><a href="#edge-flips-t1s" id="toc-edge-flips-t1s" class="nav-link" data-scroll-target="#edge-flips-t1s">Edge flips / T1s</a>
  <ul class="collapse">
  <li><a href="#flip_edge" id="toc-flip_edge" class="nav-link" data-scroll-target="#flip_edge">flip_edge</a></li>
  <li><a href="#get_signed_dual_he_length" id="toc-get_signed_dual_he_length" class="nav-link" data-scroll-target="#get_signed_dual_he_length">get_signed_dual_he_length</a></li>
  <li><a href="#flip_all" id="toc-flip_all" class="nav-link" data-scroll-target="#flip_all">flip_all</a></li>
  </ul></li>
  <li><a href="#adjacency-like-operators-on-half-edge-meshes" id="toc-adjacency-like-operators-on-half-edge-meshes" class="nav-link" data-scroll-target="#adjacency-like-operators-on-half-edge-meshes">Adjacency-like operators on half-edge meshes</a>
  <ul class="collapse">
  <li><a href="#computing-cell-areas-perimeters-etc-via-corners" id="toc-computing-cell-areas-perimeters-etc-via-corners" class="nav-link" data-scroll-target="#computing-cell-areas-perimeters-etc-via-corners">Computing cell areas, perimeters, etc via corners</a></li>
  <li><a href="#sum_he_to_vertex_opposite" id="toc-sum_he_to_vertex_opposite" class="nav-link" data-scroll-target="#sum_he_to_vertex_opposite">sum_he_to_vertex_opposite</a></li>
  <li><a href="#sum_he_to_vertex_incoming" id="toc-sum_he_to_vertex_incoming" class="nav-link" data-scroll-target="#sum_he_to_vertex_incoming">sum_he_to_vertex_incoming</a></li>
  <li><a href="#get_cell_areas" id="toc-get_cell_areas" class="nav-link" data-scroll-target="#get_cell_areas">get_cell_areas</a></li>
  </ul></li>
  <li><a href="#saving-to-disk" id="toc-saving-to-disk" class="nav-link" data-scroll-target="#saving-to-disk">Saving to disk</a>
  <ul class="collapse">
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/nikolas-claussen/triangulax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="01_triangulation_datastructure.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="jax-compatible-data-structure-triangulations" class="level2">
<h2 class="anchored" data-anchor-id="jax-compatible-data-structure-triangulations">JAX-compatible data structure triangulations</h2>
<p>First, we need to create a suitable data structure to describe cell arrays. We will represent cell tilings by 2D Voronoi tessellations and variants thereof (like power diagrams). Cells are denoted by Latin indices <span class="math inline">\(i,j,k, \dots\)</span>. Voronoi tessellations are dual to Delaunay triangulations (each Voronoi vertex is a Delaunay triangle). This means that we can represent the cell network as a 2D triangulation with vertices <span class="math inline">\(V\)</span> and faces <span class="math inline">\(F\)</span>. Each face is an (ordered) triple of vertices <span class="math inline">\((i,j,k)\)</span>. Vertex positions are denoted <span class="math inline">\(\mathbf{v}_i\)</span>.</p>
<p>We will first consider the case where the number of vertices does not change. Cells can, however, rearrange (T1-transitions/edge flips in the triangulation). Such flips also conserve the number of faces and edges. In addition to the vertices and faces, we will need to store various <em>attributes</em> for vertices, faces, and edges (for example, the edge lengths, or the Voronoi position of a face).</p>
<section id="coding-style-notes" class="level3">
<h3 class="anchored" data-anchor-id="coding-style-notes">Coding style notes</h3>
<p>Throughout, we will (attempt to) provide a type signature for all functions. To do so for array-based functions, we use <a href="https://docs.kidger.site/jaxtyping">jaxtyping</a>.</p>
</section>
<section id="jax" class="level3">
<h3 class="anchored" data-anchor-id="jax">JAX</h3>
<p>The aim is to create a triangulation datastructure compatible with the JAX library for automatic differentiation and numerical computing. In practice, this means that we use <code>jnp</code> (=<code>jax.numpy</code>) instead of <code>numpy</code>, and make sure our code follows JAX’s functional programming paradigm (see <a href="https://docs.jax.dev/en/latest/notebooks/Common_Gotchas_in_JAX.html">JAX- the sharp bits</a>). There is also some extra legwork to register any new classes with JAX.</p>
</section>
<section id="triangular-mesh-datastructure" class="level3">
<h3 class="anchored" data-anchor-id="triangular-mesh-datastructure">Triangular mesh datastructure</h3>
<p>The simplest way to represent a cell tiling is by its <em>dual</em> triangular mesh (one triangulation vertex per cell). Triangles will be denoted as <em>faces</em>. We thus represent a cell tiling by:</p>
<ol type="1">
<li>A set of vertices, i.e., a <span class="math inline">\((N_V, 2)\)</span> dimensional array datatype <code>float</code>.</li>
<li>A set of faces, a <span class="math inline">\((N_F, 3)\)</span> dimensional array of datatype <code>int</code>. Each row is a triple of vertex indices that form a face.</li>
<li>A set of face positions, a <span class="math inline">\((N_F, 2)\)</span> dimensional array of datatype <code>float</code>. An entry is the position of the tesselation vertex dual to the triangulation face.</li>
</ol>
<p>To read and write, we use the <code>.obj</code>-file format. We will also make heavy use of the <code>igl</code> geometry processing library. We start by defining a minimal <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#trimesh"><code>TriMesh</code></a> class for our cell-tiling objects. This class is mainly a “holder” class for loading, saving, visualizing, etc meshes, and not to be used for numerical computation. We come to that below.</p>
<p>Further below, we will also add optional attributes for faces, vertices, and edges. Each attribute is a dictionary with keys (from an <code>Enum</code> of possibilities) and values, which are <code>numpy</code> vectors whose <span class="math inline">\(n\)</span>th entry corresponds to vertex/face/edge <span class="math inline">\(n\)</span>. For this reason, vertices/faces/edges are <em>ordered</em>.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L41" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="trimesh" class="level3">
<h3 class="anchored" data-anchor-id="trimesh">TriMesh</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> TriMesh(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    vertices:Float[Array, <span class="st">'n_vertices dim'</span>], faces:Int[Array, <span class="st">'n_faces 3'</span>], face_positions:Union<span class="op">=</span><span class="va">None</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Simple class for reading, holding, transforming, and saving triangular meshes.</em></p>
<p>A TriMesh comprises vertices and faces, describing a surface in 2d or 3d. In addition, there can be a 2d/3d position for every face (think Voronoi dual of the triangulation).</p>
<p>Vertices and faces are jnp.arrays. Each face is a triple of vertex indices. Vertices and faces are ordered - this is essential so that we know which attribute vector entry goes to which vector/edge/face. Faces in a face are assumed to be in counter-clockwise order.</p>
<p>Meshes are read and written in the .obj format (https://en.wikipedia.org/wiki/Wavefront_.obj_file). To store <em>face_positions</em>, we abuse the <code>vn</code> (vertex normal) entry of an .obj file. Face positions will be written in order corresponding to faces. When reading from an .obj file, edges are recomputed from faces and initialized in alpha-numerical ordering. An .obj file expects 3d positions; the z-position is ignored when reading and set to 0 when writing for 2d meshes.</p>
<p><strong>Attributes</strong></p>
<p>dim : int = 2</p>
<p>vertices : Float[jax.Array, “n_vertices dim”]</p>
<p>faces : Int[jax.Array, “n_faces 3”]</p>
<p>face_positions : Float[jax.Array, “n_faces dim”]</p>
<p><strong>Property methods (use like attributes)</strong></p>
<p>n_vertices : int</p>
<p>has_inf_vertex : bool</p>
<p><strong>Static methods</strong></p>
<p>read_obj : str -&gt; TriMesh</p>
<p><strong>Methods</strong></p>
<p>write_obj : str -&gt; None</p>
<div id="c92469ca-bcb7-424f-ab1a-57391c5c955a" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test reading a mesh</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="bef6e5d3-ea7d-49de-92ac-ba58c4a08c96" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test computing the circumcenter of each face. should be equidistant to all vertex points</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>dists <span class="op">=</span> jnp.stack([jnp.linalg.norm(mesh.vertices[mesh.faces[:,i]]<span class="op">-</span>mesh.face_positions, axis<span class="op">=</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>]], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>jnp.allclose(dists[:,<span class="dv">0</span>], dists[:,<span class="dv">1</span>]) <span class="kw">and</span> jnp.allclose(dists[:,<span class="dv">1</span>], dists[:,<span class="dv">2</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>Array(True, dtype=bool)</code></pre>
</div>
</div>
<div id="3adefefb-2b1a-4c44-b6c0-8a5e78cdb053" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test writing face positions to vn entries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"test_meshes/disk_write_test.obj"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>mesh.write_obj(filename, save_face_positions<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(filename, read_face_positions<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
</section>
<section id="creating-meshes-and-plotting" class="level3">
<h3 class="anchored" data-anchor-id="creating-meshes-and-plotting">Creating meshes and plotting</h3>
<p>Some functions to create meshes based on the Delaunay triangulation of a point set.</p>
<ol type="1">
<li>Poisson (vertices placed uniformly at random) in disk or box</li>
<li>Ginibre (vertices placed at uniform with self-repulsion)</li>
<li>Triangular lattice</li>
</ol>
<p>Some functions for plotting meshes:</p>
<ol type="1">
<li>Plot triangulation with vertex and face labels (for debugging)</li>
<li>Plot cell tesselation</li>
</ol>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L183" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_triangular_lattice" class="level3">
<h3 class="anchored" data-anchor-id="generate_triangular_lattice">generate_triangular_lattice</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_triangular_lattice(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    nx:<span class="bu">int</span>, ny:<span class="bu">int</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'nx*ny 2'</span>]:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get points for rectangular patch of triangular lattice with nx, ny points.</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L175" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_poisson_points" class="level3">
<h3 class="anchored" data-anchor-id="generate_poisson_points">generate_poisson_points</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_poisson_points(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    n_vertices:<span class="bu">int</span>, limit_x:<span class="bu">float</span><span class="op">=</span><span class="dv">1</span>, limit_y:<span class="bu">float</span><span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'n_vertices 2'</span>]:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Sample n_vertices points from the Poisson ensemble in rectangle</em> [-limit_x/2, limit_x/2] * [-limit_y/2, limit_y/2].</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L166" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="generate_ginibre_points" class="level3">
<h3 class="anchored" data-anchor-id="generate_ginibre_points">generate_ginibre_points</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_ginibre_points(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    n_vertices:<span class="bu">int</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'n_vertices 2'</span>]:</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Sample n_vertices points from the Ginibre ensemble. Points are scaled to unit disk.</em></p>
<div id="da57dbe6-026e-4dab-82be-0691e6037d71" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#points = generate_triangular_lattice(10, 10)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> generate_ginibre_points(<span class="dv">100</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh(vertices<span class="op">=</span>points, faces<span class="op">=</span>jnp.array(spatial.Delaunay(points).simplices))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>points.T, mesh.faces)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>plt.scatter(<span class="op">*</span>points.T)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(np.float64(-1.6315276371405518),
 np.float64(1.6191872290800107),
 np.float64(-1.4880190145409438),
 np.float64(1.7089872695623352))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="elementary-book-keeping-using-list-of-triangles-data-structure" class="level3">
<h3 class="anchored" data-anchor-id="elementary-book-keeping-using-list-of-triangles-data-structure">Elementary book-keeping using list-of-triangles data structure</h3>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L197" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_adjacent_vertex_indices" class="level3">
<h3 class="anchored" data-anchor-id="get_adjacent_vertex_indices">get_adjacent_vertex_indices</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_adjacent_vertex_indices(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    faces:Int[Array, <span class="st">'n_faces 3'</span>], n_vertices:<span class="bu">int</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">list</span>:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>For each vertex, get the indices of the adjacent vertices in correct order.</em> For boundary vertices, this list contains the vertex itself.</p>
<div id="7d5a6c59-59ff-4f56-b743-bc591edd70fd" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>neighbors <span class="op">=</span> get_adjacent_vertex_indices(mesh.faces, n_vertices<span class="op">=</span>mesh.vertices.shape[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
</section>
</section>
<section id="half-edge-meshes" class="level2">
<h2 class="anchored" data-anchor-id="half-edge-meshes">Half-edge meshes</h2>
<p>For simulation and geometry processing, we need a different representation of the adjacency information than the list of triangle (for example, to compute the area of a cell). Typically, this is achieved by a <a href="https://www.jerryyin.info/geometry-processing-algorithms/half-edge/">half-edge mesh</a> (HE) data structure. We represent the HE data structure by 3 sets of integer index arrays:</p>
<ol type="1">
<li>Vertices: 1 <span class="math inline">\((N_V,)\)</span> matrix, whose entry for vertex <span class="math inline">\(i\)</span> is an arbitrary HE incident on <span class="math inline">\(i\)</span></li>
<li>Edges: 6 <span class="math inline">\((2N_E,)\)</span> matrices, [<code>origin</code>, <code>dest</code>, <code>nxt</code>, <code>prv</code>, <code>twin</code>, <code>face</code>] for each half-edge. <code>face</code> can be <code>np.nan</code> for boundary vertices.</li>
<li>Faces, 1 <span class="math inline">\((N_F, 1)\)</span> matrix, whose entry for face <span class="math inline">\(i\)</span> is an arbitrary HE in <span class="math inline">\(i\)</span>. (Not to be confused with the <span class="math inline">\((N_F, 3)\)</span> matrix of <em>vertex IDs</em> used previously).</li>
</ol>
<p>Additionally, there are two float arrays for vertex and face positions, as previously. However, we split <em>combinatorial</em> and <em>geometric</em> information - a <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> class for the combinatorics, and a couple of regular arrays for the vertex positions, face positions, and vertex/half-edge/face attributes. The latter are packaged into a <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#geommesh"><code>GeomMesh</code></a> class. Together, the pair <code>(GeomMesh, HeMesh)</code> describes a mesh (like vertices/faces pair). A named tuple <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#mesh"><code>Mesh</code></a> comines the two.</p>
<p>The first task is to create a helper function to plot mesh connectivity, and to create the half-edge connectivity matrices from the more conventional list-of-triangles format. The latter is somewhat involved.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L207" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="label_plot" class="level3">
<h3 class="anchored" data-anchor-id="label_plot">label_plot</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_plot(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    vertices:Float[Array, <span class="st">'n_vertices 2'</span>], faces:Int[Array, <span class="st">'n_faces 3'</span>], hemesh:Union<span class="op">=</span><span class="va">None</span>, vertex_labels:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    face_labels:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, ax:Union<span class="op">=</span><span class="va">None</span>, fontsize:Union<span class="op">=</span><span class="va">None</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>For debugging purposes. Plot triangular mesh with face/vertex labels in black/blue.</em> If hemesh is not None, the connectivity info from it is used to plot the half-edge labels.</p>
<div id="4b8abf3e-57c3-4210-9b7a-50ded06d7118" class="cell" data-scrolled="true" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>mesh.vertices.T, mesh.faces)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>label_plot(mesh.vertices, mesh.faces, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>(np.float64(-1.10003475),
 np.float64(1.09628575),
 np.float64(-1.09934025),
 np.float64(1.09050125))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L233" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_half_edge_arrays" class="level3">
<h3 class="anchored" data-anchor-id="get_half_edge_arrays">get_half_edge_arrays</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_half_edge_arrays(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    n_vertices:<span class="bu">int</span>, faces:Int[Array, <span class="st">'n_faces 3'</span>]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">list</span>:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get half-edge data structure arrays from faces.</em></p>
<p>Returns: incident, orig, dest, twin, nxt, prv, heface, face_incident</p>
</section>
<section id="jax-compatibility" class="level3">
<h3 class="anchored" data-anchor-id="jax-compatibility">JAX compatibility</h3>
<p>We want to be compatible with JAX. For this reason, we</p>
<ol type="1">
<li>Always use <code>jnp</code> = <code>jax.numpy</code> instead of <code>np</code></li>
<li>Instead of in-place array modifications, use JAX’s <code>x = x.at[idx].set(y)</code> syntax</li>
<li><em>Avoid</em> any in-place modifications in the <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> and <code>GeomHeMesh</code> data structures</li>
<li><em>Register</em> our (data)classes with JAX, so JAX knows how to handle them during gradient-computation and just-in-time compilation. See <a href="https://docs.jax.dev/en/latest/notebooks/Common_Gotchas_in_JAX.html#using-jax-jit-with-class-methods">here</a> and <a href="https://docs.jax.dev/en/latest/custom_pytrees.html">here</a>. This involves declaring which parts are mutable and which parts are permanent.</li>
</ol>
<p>Lateron, for simulations, we use the <code>equinox</code> library, which adds a few useful tools to JAX. (A neural-network library like <code>flax</code> is probably overkill).</p>
<section id="pytrees" class="level4">
<h4 class="anchored" data-anchor-id="pytrees">PyTrees</h4>
<p>JAX supports not only arrays as inputs/outputs/intermediate variables, but also <a href="https://docs.jax.dev/en/latest/pytrees.html">pytrees</a>. Pytrees are nested structures (dicts, lists-of-lists, etc) whose leaves are “elementary” objects like arrays. Fortunately, our <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> class is already a lot like a pytree - it is a collection of arrays. For JAX to understand this, we need to register our <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> class as a <a href="https://docs.jax.dev/en/latest/custom_pytrees.html#pytrees-custom-pytree-nodes">custom pytree node</a>. We register our dataclasses using <code>jax.tree_util.register_dataclass</code>.</p>
<p>Sidenote: Neural networks, in libraries like Flax or Equinox, are basically very similar. They are dataclass-like classes which hold all the arrays associated with a NN (the different weights, and maybe some parameters) with class methods like <code>__call__</code> specifying the forward pass through the NN. Equinox automatically registers your NN as a pytree by inheriting from the <code>equinox.Module</code> class.</p>
</section>
<section id="control-flow" class="level4">
<h4 class="anchored" data-anchor-id="control-flow"><a href="https://docs.jax.dev/en/latest/control-flow.html">Control flow</a></h4>
<p>For just-in-time compilation, JAX distinguishes two types of variables: dynamic and static. Control flow cannot depend on the <em>value</em> of dynamic variables, only on their shape.</p>
<p>Upshots: 1. replace <code>if</code> with <code>jax.lax.cond</code> / <code>jnp.where</code> (full autodiff compatible), and <code>while</code> with <code>jax.lax.while_loop</code> (forward autodiff only). 2. mark variables which are not going to change during simulation as static.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L270" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="hemesh" class="level3">
<h3 class="anchored" data-anchor-id="hemesh">HeMesh</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> HeMesh(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    incident:Int[Array, <span class="st">'*batch n_vertices'</span>], orig:Int[Array, <span class="st">'*batch n_hes'</span>], dest:Int[Array, <span class="st">'*batch n_hes'</span>],</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    twin:Int[Array, <span class="st">'*batch n_hes'</span>], nxt:Int[Array, <span class="st">'*batch n_hes'</span>], prv:Int[Array, <span class="st">'*batch n_hes'</span>],</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    heface:Int[Array, <span class="st">'*batch n_hes'</span>], face_incident:Int[Array, <span class="st">'*batch n_faces'</span>], inf_vertices:Union<span class="op">=</span>()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Half-edge mesh data structure for triangular meshes.</em></p>
<p>A half-edge mesh is described by a set of half-edges and several arrays that specify their connectivity (see markup explanation above). This class serves as a container for multiple arrays. For future compatibility with JAX, after initialization, do not modify these arrays in-place; always return a new HeMesh object. The mesh vertices may live in whatever dimension - this does not affect the connectivity bookkeeping.</p>
<p>Half-edge meshes are initialized from a list of triangles and a number of vertices, and can return the original triangles (e.g., to save as a .obj).</p>
<p>All information and methods are purely “combinatorial”. The HeMesh class does <em>not</em> contain the vertex or face positions. These are saved in the GeomHeMesh class that combines a HeMesh (combinatorics) with a couple of other arrays (geometry).</p>
<p>—Conventions—</p>
<p>For vertices, the <code>incident</code> half-edge points <em>away</em> from the vertex.</p>
<p>To describe the mesh boundary, there are two options: 1. Initialize from a triangulation with a boundary. Half-edges without a face (boundary) are assigned heface=-1. 2. Initialize from a triangulation without boundary, where certain vertices are “at infinity”. They should have coordinates [np.inf, np.inf]. Each infinity vertex corresponds to one boundary. For a single boundary, the vertex at infinity is, by convention, the final one.</p>
<p>Starting from a set of triangles, the half-edges are initialized as follows: The 1st N_edges half-edges are (origin_vertex, destination_vertex), in lexicographic order, with origin_vertex &lt; destination_vertex. The 2nd N_edges are their twins, in the same order.</p>
<p><strong>Attributes</strong></p>
<p>incident : Int[jax.Array, “n_vertices”]</p>
<p>orig : Int[jax.Array, “n_hes”]</p>
<p>dest : Int[jax.Array, “n_hes”]</p>
<p>nxt : Int[jax.Array, “n_hes”]</p>
<p>prv : Int[jax.Array, “n_hes”]</p>
<p>twin : Int[jax.Array, “n_hes”]</p>
<p>heface : Int[jax.Array, “n_hes”]</p>
<p>face_incident : Int[jax.Array, “n_faces”]</p>
<p>inf_vertices : tuple[Int]</p>
<p><strong>Property methods (use like attributes)</strong></p>
<p>n_vertices : int</p>
<p>n_hes : int</p>
<p>n_faces : int</p>
<p>n_items : tuple[int, int, int]</p>
<p>faces : Int[jax.Array, “n_faces 3”]</p>
<p>has_inf_vertex : bool</p>
<p>is_inf_face : Bool[jax.Array, “n_faces”]</p>
<p>is_unique : Bool[jax.Array, “n_hes”]</p>
<p>is_inf_he : Bool[jax.Array, “n_hes”]</p>
<p>is_bdry_he : Bool[jax.Array, “n_hes”]</p>
<p>is_bdry_edge : Bool[jax.Array, “n_hes”]</p>
<p>is_bdry : Bool[jax.Array, “n_vertices”]</p>
<p><strong>Static methods</strong></p>
<p>from_triangles : tuple[int, Int[jax.Array, “n_faces 3”], Int[jax.Array, “n_boundaries”] -&gt; HeMesh</p>
<p><strong>Class methods</strong></p>
<p>iterate_around_vertex : int -&gt; Int[jax.Array, “n_neighbors”]</p>
<p>save : str -&gt; None:</p>
<p><strong>Static methods</strong></p>
<p>load : str -&gt; HeMesh</p>
<div id="5fe4070e-5447-4716-b0da-38adca86b921" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="b05bdc43-7033-420b-bbdf-0daf113ed228" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hemeshes can be compared for equali and are registered as py-trees</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>leafs, ts <span class="op">=</span> jax.tree_util.tree_flatten(hemesh)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>hemesh, hemesh <span class="op">==</span> hemesh</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(HeMesh(N_V=131, N_HE=708, N_F=224), True)</code></pre>
</div>
</div>
<div id="5363c9ed" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test iteration around vertex</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>hemesh.dest[hemesh.iterate_around_vertex(<span class="dv">69</span>)], hemesh.orig[hemesh.iterate_around_vertex(<span class="dv">56</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>(Array([80, 68, 56, 46], dtype=int64),
 Array([56, 56, 56, 56, 56, 56, 56], dtype=int64))</code></pre>
</div>
</div>
<div id="e19181b5" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boundary in cc-wise order</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>(hemesh.orig[<span class="dv">187</span>], hemesh.dest[<span class="dv">187</span>]), hemesh.heface[<span class="dv">187</span>], hemesh.is_bdry_he[<span class="dv">187</span>],</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>((Array(58, dtype=int64), Array(70, dtype=int64)),
 Array(-1, dtype=int64),
 Array(True, dtype=bool))</code></pre>
</div>
</div>
<div id="6525ab64" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>hemesh.is_bdry_he[<span class="dv">187</span>], hemesh.is_bdry_he[<span class="dv">541</span>], hemesh.heface[<span class="dv">541</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>(Array(True, dtype=bool), Array(False, dtype=bool), Array(145, dtype=int64))</code></pre>
</div>
</div>
<div id="e6f9df51" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to model mesh boundaries, we can add an "infinity" vertex. Not done here, see below</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>hemesh.has_inf_vertex, hemesh.inf_vertices</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>(False, ())</code></pre>
</div>
</div>
<div id="e5c1c05d" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>,<span class="dv">14</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>mesh.vertices.T, hemesh.faces)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>label_plot(mesh.vertices, hemesh.faces, fontsize<span class="op">=</span><span class="dv">10</span>, hemesh<span class="op">=</span>hemesh, face_labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(np.float64(-1.10003475),
 np.float64(1.09628575),
 np.float64(-1.09934025),
 np.float64(1.09050125))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9ffe63d8-0da6-4c74-bef7-c35727d76ff9" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here is how you would do mesh traversal with jax.lax. The issues is that the output size needs to be fixed</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ahead of time, so </span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="va">self</span> <span class="op">=</span> hemesh</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>max_valence <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>initial <span class="op">=</span> jnp.hstack([jnp.array([<span class="va">self</span>.incident[v]]), <span class="op">-</span><span class="dv">1</span><span class="op">*</span>jnp.ones(max_valence<span class="op">-</span><span class="dv">1</span>, dtype<span class="op">=</span><span class="bu">int</span>)])</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>jax.lax.fori_loop(<span class="dv">1</span>, max_valence, <span class="kw">lambda</span> i, x: x.at[i].<span class="bu">set</span>(<span class="va">self</span>.twin[x[i<span class="op">-</span><span class="dv">1</span>]]), initial)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>Array([ 47, 401,  47, 401,  47, 401,  47, 401,  47, 401], dtype=int64)</code></pre>
</div>
</div>
</section>
<section id="boundary-and-the-vertex-at-infinity" class="level3">
<h3 class="anchored" data-anchor-id="boundary-and-the-vertex-at-infinity">Boundary and the vertex at infinity</h3>
<p>So far, our mesh representations <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#trimesh"><code>TriMesh</code></a> and <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> work for triangular meshes with and without boundary. Boundary half-edges are assigned to a fictitious <code>-1</code> face. This convention has a downside. It is not possible to modify the boundary loop of the mesh by edge flips - doing so would result in an invalid state. In a simulation, this artificially limits the mesh’s ability to deform. Instead, we can add “vertices at infinity” and connect al edges in a given boundary to <span class="math inline">\(\infty\)</span>. This turns the mesh into a topological sphere. Now, one can flip boundary edges without the overall number of half-edges changing (so the array shape stays the same). Multiple boundaries are also supported. Each boundary corresponds to a distinct <span class="math inline">\(\infty\)</span>-vertex (for example, 2 for a cylinder)/</p>
<p>The coordinates of the fictitious vertices are set to <code>[np.inf, np.inf]</code> by convention. The boundary is found by iterating around <span class="math inline">\(\infty\)</span>. By convention, <span class="math inline">\(\infty\)</span>-vertices, if they exists, are the final vertices of the mesh (don’t rely on this - implementation detail).</p>
<p>We generally assume that the mesh has only a single connected component.</p>
<p>The <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> class can deal with both the -1-face and the <span class="math inline">\(\infty\)</span>-vertices conventions. The latter are listed in the <code>inf_vertices</code> attribute of a <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a>.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L494" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="connect_boundary_to_infinity" class="level3">
<h3 class="anchored" data-anchor-id="connect_boundary_to_infinity">connect_boundary_to_infinity</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_boundary_to_infinity(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    vertices:Float[Array, <span class="st">'n_vertices 2'</span>], <span class="co"># Vertex positions.</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    faces:Int[Array, <span class="st">'n_faces 3'</span>], <span class="co"># Faces (triangles) as list of vertex indices.</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">tuple</span>: <span class="co"># Vertex positions with infinity vertices appended.</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>One infinity vertex per boundary loop.</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Connect boundary loop(s) to infinity.</em></p>
<p>New vertices are appeneded to the end of vertex array and have coordinates [np.inf, np.inf].</p>
<div id="0f81dc06" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="8a429fcb" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>new_vertices, new_faces, infinity_vertices <span class="op">=</span> connect_boundary_to_infinity(mesh.vertices, mesh.faces)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>mesh_infty <span class="op">=</span> TriMesh(vertices<span class="op">=</span>new_vertices, faces<span class="op">=</span>new_faces)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>hemesh_infty <span class="op">=</span> HeMesh.from_triangles(mesh_infty.vertices.shape[<span class="dv">0</span>], mesh_infty.faces,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                                     inf_vertices<span class="op">=</span>infinity_vertices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7db747fb" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>igl.is_edge_manifold(mesh_infty.faces)[<span class="dv">0</span>], igl.is_vertex_manifold(mesh_infty.faces)[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>(True, np.True_)</code></pre>
</div>
</div>
<div id="7877f979" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>hemesh_infty.dest[hemesh_infty.iterate_around_vertex(<span class="op">-</span><span class="dv">1</span>)], igl.boundary_loop(mesh.faces)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>(Array([  0,  10,  21,  34,  47,  58,  70,  86,  91, 100, 108, 113, 114,
        110, 111, 112, 107,  99,  85,  80,  69,  46,  33,  32,  20,   9,
        130, 121, 120, 119, 118, 117, 116, 115, 123, 122], dtype=int64),
 array([  0, 122, 123, 115, 116, 117, 118, 119, 120, 121, 130,   9,  20,
         32,  33,  46,  69,  80,  85,  99, 107, 112, 111, 110, 114, 113,
        108, 100,  91,  86,  70,  58,  47,  34,  21,  10], dtype=int64))</code></pre>
</div>
</div>
<div id="3f091294" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>hemesh_infty.dest[hemesh_infty.iterate_around_vertex(<span class="dv">0</span>)], hemesh.dest[hemesh.iterate_around_vertex(<span class="dv">0</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>(Array([  1,  11,  10, 131, 122], dtype=int64),
 Array([  1,  11,  10, 122], dtype=int64))</code></pre>
</div>
</div>
<div id="a644a364" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(hemesh.is_bdry <span class="op">==</span> (hemesh_infty.is_bdry[:<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span><span class="dv">0</span>)).<span class="bu">all</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>Array(True, dtype=bool)</code></pre>
</div>
</div>
<div id="e2505ce7" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to get back the original faces/vertices, do this:</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> hemesh_infty.faces[<span class="op">~</span>hemesh_infty.is_inf_face]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="mesh-geometry-and-per-mesh-variables" class="level2">
<h2 class="anchored" data-anchor-id="mesh-geometry-and-per-mesh-variables">Mesh geometry and per-mesh variables</h2>
<p>Mesh geometry (vertex and face positions) and per-mesh-item (per-face, per-half-edge, per-vertex) variables are combined into a second data class, the <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#geommesh"><code>GeomMesh</code></a>.</p>
<section id="vertex-half-edge-and-face-properties" class="level3">
<h3 class="anchored" data-anchor-id="vertex-half-edge-and-face-properties">Vertex, half-edge, and face properties</h3>
<p>In simulations, we will often want to attach extra information to a mesh’s vertices/edges/faces. In the <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#geommesh"><code>GeomMesh</code></a> class, these are saved in three dictionaries, <code>vertex_attribs</code>, <code>he_attribs</code>, <code>face_attribs</code>. Each key/value pair represents one property (for example, the cell target area). All values are arrays, and the first axis corresponds to the number of vertices/half-edges/faces, respectively. To keep track of the possible attributes, we use <code>IntEnum</code>’s as keys (this also ensures keys are hashable, as required by JAX)</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L546" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="faceattribs" class="level3">
<h3 class="anchored" data-anchor-id="faceattribs">FaceAttribs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> FaceAttribs(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Enum where members are also (and must be) ints</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L543" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="heattribs" class="level3">
<h3 class="anchored" data-anchor-id="heattribs">HeAttribs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> HeAttribs(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Enum where members are also (and must be) ints</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L539" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="vertexattribs" class="level3">
<h3 class="anchored" data-anchor-id="vertexattribs">VertexAttribs</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> VertexAttribs(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Enum where members are also (and must be) ints</em></p>
<div id="97f8169c" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>HeAttribs.EDGE_TENSION, HeAttribs(<span class="dv">1</span>), HeAttribs[<span class="st">'EDGE_TENSION'</span>], HeAttribs.EDGE_TENSION.name</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>(&lt;HeAttribs.EDGE_TENSION: 1&gt;,
 &lt;HeAttribs.EDGE_TENSION: 1&gt;,
 &lt;HeAttribs.EDGE_TENSION: 1&gt;,
 'EDGE_TENSION')</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L556" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="geommesh" class="level3">
<h3 class="anchored" data-anchor-id="geommesh">GeomMesh</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> GeomMesh(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    n_vertices:<span class="bu">int</span>, n_hes:<span class="bu">int</span>, n_faces:<span class="bu">int</span>, vertices:Float[Array, <span class="st">'*batch n_vertices dim'</span>],</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    face_positions:Float[Array, <span class="st">'*batch n_faces 2'</span>]<span class="op">=&lt;</span>factory<span class="op">&gt;</span>, vertex_attribs:<span class="bu">dict</span><span class="op">=&lt;</span>factory<span class="op">&gt;</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    he_attribs:<span class="bu">dict</span><span class="op">=&lt;</span>factory<span class="op">&gt;</span>, face_attribs:<span class="bu">dict</span><span class="op">=&lt;</span>factory<span class="op">&gt;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="va">None</span>:</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Data class for holding mesh geometry and mesh-associated variables.</em> To be combined with a HeMesh to specify the connectivity.</p>
<p>One array (for vertex positions) must always be present. A second, but optional, standard entry is a set of positions for each face. The mesh coordinates can live in 2d or 3d.</p>
<p>Optionally, vertices, half-edges, and faces can have attributes (stored as dictionaries). The keys of the dictionary should be taken from a suitable ‘enum’. The values are ndarrays, whose 0th axis is (vertices/edges/faces). These attribute dicts are initialized empty and can be set afterwards.</p>
<p>See documentation on HeMesh</p>
<p><strong>Attributes</strong></p>
<p>vertices : Float[jax.Array, “n_vertices 2”]</p>
<p>face_positions : Float[jax.Array, “n_faces 2”]</p>
<p>vertex_attribs : dict[IntEnum, Float[jax.Array, “n_vertices *”]]</p>
<p>he_attribs : dict[IntEnum, Float[jax.Array, “n_hes *”]]</p>
<p>face_attribs : dict[IntEnum, Float[jax.Array, “n_faces *”]]</p>
<p><strong>Property methods (use like attributes)</strong></p>
<p>n_items : tuple[int, int, int]</p>
<p>dim : int</p>
<p><strong>Class methods</strong></p>
<p>validate_dimensions : bool</p>
<p><strong>Static methods</strong></p>
<p>load : str -&gt; GeomHeMesh</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L692" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="set_voronoi_face_positions" class="level3">
<h3 class="anchored" data-anchor-id="set_voronoi_face_positions">set_voronoi_face_positions</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_voronoi_face_positions(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    geommesh:GeomMesh, hemesh:HeMesh</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>GeomMesh:</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Set face positions of geommesh to the circumcenters of the faces defined by hemesh.</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L686" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_voronoi_face_positions" class="level3">
<h3 class="anchored" data-anchor-id="get_voronoi_face_positions">get_voronoi_face_positions</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_voronoi_face_positions(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    vertices:Float[Array, <span class="st">'n_vertices 2'</span>], hemesh:HeMesh</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'n_faces 2'</span>]:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Get face positions of geommesh to the circumcenters of the faces defined by hemesh.</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L698" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mesh" class="level3">
<h3 class="anchored" data-anchor-id="mesh">Mesh</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Mesh(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Combine geometric and connectivity info into a single object.</em></p>
<div id="c78f0f4a-6bea-40e5-baf3-628f777b1d0f" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, mesh.vertices, mesh.face_positions)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="88381eed-c22c-49cd-8606-c62500eb28a7" class="cell" data-scrolled="true" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>combined_mesh <span class="op">=</span> Mesh(geommesh, hemesh)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>combined_mesh</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>Mesh(geommesh=GeomMesh(D=2,N_V=131, N_HE=708, N_F=224), hemesh=HeMesh(N_V=131, N_HE=708, N_F=224))</code></pre>
</div>
</div>
<div id="fc035cf3-bf00-42e9-a2f3-103c240e3fe0" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>leafs, ts <span class="op">=</span> jax.tree_util.tree_flatten(geommesh) <span class="co"># also a pytree</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>ts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>PyTreeDef(CustomNode(GeomMesh[(131, 708, 224)], [*, *, {}, {}, {}]))</code></pre>
</div>
</div>
<div id="c006504e-0193-4831-9ade-5c7cec6b3d47" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>geommesh, geommesh.n_vertices, geommesh.vertices.shape, geommesh.check_compatibility(hemesh), geommesh <span class="op">==</span> geommesh</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>(GeomMesh(D=2,N_V=131, N_HE=708, N_F=224), 131, (131, 2), True, True)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L704" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cellplot" class="level3">
<h3 class="anchored" data-anchor-id="cellplot">cellplot</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cellplot(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    hemesh:HeMesh, face_positions:Float[Array, <span class="st">'n_faces 2'</span>], cell_colors:Union<span class="op">=</span><span class="va">None</span>, mpl_polygon_kwargs:Union<span class="op">=</span><span class="va">None</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>PatchCollection:</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Plot a cell tesselation.</em></p>
<p>cell_colors can be either a single color (for all cells) or a vector of rgba values. Only interior cells are plotted.</p>
<div id="b4496688-152b-43d0-b66f-b1b11718c849" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>geommesh.vertices.T, hemesh.faces)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>polygons <span class="op">=</span> cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>                    cell_colors<span class="op">=</span>np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.5</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>})</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.gca()</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>ax.add_collection(polygons)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(np.float64(-1.10003475),
 np.float64(1.09628575),
 np.float64(-1.09934025),
 np.float64(1.09050125))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-45-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-some-vertexhalf-edgeface-properties" class="level3">
<h3 class="anchored" data-anchor-id="adding-some-vertexhalf-edgeface-properties">Adding some vertex/half-edge/face properties</h3>
<div id="452cebbe" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>geommmesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, mesh.vertices, mesh.face_positions)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="c78e5b0b" class="cell" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># at initialization, a HeMesh's attribute dictionaries are empty</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>geommmesh.vertex_attribs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>{}</code></pre>
</div>
</div>
<div id="edd75cb5" class="cell" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set some attributes</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>key1 <span class="op">=</span> jax.random.key(<span class="dv">0</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>_, key2 <span class="op">=</span> jax.random.split(key1)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>_, key3 <span class="op">=</span> jax.random.split(key2)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>geommmesh <span class="op">=</span> dataclasses.replace(geommmesh, vertex_attribs<span class="op">=</span>{VertexAttribs.TARGET_AREA: jax.random.normal(key<span class="op">=</span>key1, shape<span class="op">=</span>geommmesh.n_vertices),</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>                                                           VertexAttribs.TARGET_PERIMETER: jax.random.normal(key<span class="op">=</span>key2, shape<span class="op">=</span>geommmesh.n_vertices)})</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>geommmesh <span class="op">=</span> dataclasses.replace(geommmesh, he_attribs<span class="op">=</span>{HeAttribs.EDGE_TENSION: jax.random.normal(key<span class="op">=</span>key3, shape<span class="op">=</span>geommmesh.n_hes)})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="595f136b" class="cell" data-execution_count="54">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>geommmesh.he_attribs.keys()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>dict_keys([&lt;HeAttribs.EDGE_TENSION: 1&gt;])</code></pre>
</div>
</div>
</section>
</section>
<section id="batching" class="level2">
<h2 class="anchored" data-anchor-id="batching">Batching</h2>
<p>In our simulations, we may want to “batch” over several initial conditions/random seeds/etc (analogous to batching over training data in normal ML). In JAX, we can efficiently and concisely vectorize operations over such “batch axes” with <code>jax.vmap</code>.</p>
<p>To batch over our custom data structures, we need to pull a small trick - convert a list of <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a>/<code>GeomMeshe</code> instances into a single mesh with a batch axis for the various arrays. Luckily, this can be <a href="https://stackoverflow.com/questions/79123001/storing-and-jax-vmap-over-pytrees">done using JAX’s pytree tools</a>.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L739" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="tree_unstack" class="level3">
<h3 class="anchored" data-anchor-id="tree_unstack">tree_unstack</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tree_unstack(</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    xb:PyTree, axis:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">list</span>:</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Unstack a batched pytree along axis into a list of pytrees.</em></p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L735" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="tree_stack" class="level3">
<h3 class="anchored" data-anchor-id="tree_stack">tree_stack</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tree_stack(</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    xs:<span class="bu">list</span>, axis:<span class="bu">int</span><span class="op">=</span><span class="dv">0</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>PyTree:</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Stack a sequence of identical-structure pytrees along a new axis.</em></p>
<div id="54eb9677" class="cell" data-execution_count="56">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Let us create a bunch of meshes with different initial positions and see if we can batch over them using vmap</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> jax.random.key(<span class="dv">0</span>)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>batch_geom <span class="op">=</span> []</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>batch_he <span class="op">=</span> []</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    key, subkey <span class="op">=</span> jax.random.split(key)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    random_noise <span class="op">=</span> jax.random.normal(subkey, shape<span class="op">=</span>geommmesh.vertices.shape)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    batch_geom.append(dataclasses.replace(geommmesh, vertices<span class="op">=</span>geommmesh.vertices<span class="op">+</span>sigma<span class="op">*</span>random_noise))</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    batch_he.append(copy.copy(hemesh))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5856c3c5" class="cell" data-execution_count="57">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a test function to appy over the batch</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_function(geommesh: GeomMesh, hemesh: HeMesh) <span class="op">-&gt;</span> Float[jax.Array, <span class="st">" n_vertices"</span>]:</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Dummy test function."""</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.ones(geommesh.n_vertices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="24cb28d8" class="cell" data-execution_count="58">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># naive batching does not work. JAX needs a "struct-of-arrays", but a list of HeMeshes is an "array-of-structs"</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># see https://stackoverflow.com/questions/79123001/storing-and-jax-vmap-over-pytrees</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    jax.vmap(test_function)(batch_geom, batch_he)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>) <span class="im">as</span> e:</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Expected error:"</span>, e)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Expected error: vmap got inconsistent sizes for array axes to be mapped:
  * most axes (21 of them) had size 708, e.g. axis 0 of argument geommesh[0].he_attribs[&lt;HeAttribs.EDGE_TENSION: 1&gt;] of type float64[708];
  * some axes (12 of them) had size 131, e.g. axis 0 of argument geommesh[0].vertices of type float64[131,2];
  * some axes (6 of them) had size 224, e.g. axis 0 of argument geommesh[0].face_positions of type float64[224,2]</code></pre>
</div>
</div>
<div id="cea01cba" class="cell" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instead, we use a jax.tree.map to "push" the list axis into the underlying arrays.</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>batch_he_array <span class="op">=</span> tree_stack(batch_he)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>batch_geom_array <span class="op">=</span> tree_stack(batch_geom)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>batch_geom_array, batch_geom_array.vertices.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>(GeomMesh(D=2,N_V=131, N_HE=708, N_F=224), (3, 131, 2))</code></pre>
</div>
</div>
<div id="3196a66a" class="cell" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>The jaxtyping extension is not loaded.</code></pre>
</div>
</div>
<div id="f976d553" class="cell" data-execution_count="61">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now it works! The result is a single object with batch axis</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>batch_out <span class="op">=</span> jax.vmap(test_function)(batch_geom_array, batch_he_array) </span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>batch_out.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>(3, 131)</code></pre>
</div>
</div>
<div id="4efdd241" class="cell" data-execution_count="62">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we can unpack things again into a list of meshes</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="bu">isinstance</span>(tree_unstack(batch_out), <span class="bu">list</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="edge-flips-t1s" class="level2">
<h2 class="anchored" data-anchor-id="edge-flips-t1s">Edge flips / T1s</h2>
<p>In our simulations, cells will exchange neighbors (T1-event). In the triangulation, this corresponds to an edge flip. We now implement the edge flip algorithm for <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a>es. We basically edit the various connectivity arrays (in a JAX-compatible way).</p>
<p>The algorithm (and the naming conventions in <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#flip_edge"><code>flip_edge</code></a>) are from here: https://jerryyin.info/geometry-processing-algorithms/half-edge/.</p>
<p><strong>Before</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/1b16caba-387e-4705-b2ea-e0adcdd61ca6-1-84d03218-dec8-4992-9150-5054fdbf5dec.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p><strong>After</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/1b16caba-387e-4705-b2ea-e0adcdd61ca6-2-86f67a10-6db4-41e8-b111-1d355d7fb2a6.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L750" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="flip_edge" class="level3">
<h3 class="anchored" data-anchor-id="flip_edge">flip_edge</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flip_edge(</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    hemesh:HeMesh, e:Int[Array, <span class="st">''</span>], check_boundary:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>HeMesh:</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Flip half-edge e in a half-edge mesh.</em></p>
<p>See https://jerryyin.info/geometry-processing-algorithms/half-edge/. The algorithm is slightly modified since we keep track of the origin and destination of a half-edge, and use arrays instead of pointers. Returns a new HeMesh, does not modify in-place.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L787" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_signed_dual_he_length" class="level3">
<h3 class="anchored" data-anchor-id="get_signed_dual_he_length">get_signed_dual_he_length</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_signed_dual_he_length(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    vertices:Float[Array, <span class="st">'n_vertices 2'</span>], face_positions:Float[Array, <span class="st">'n_hes 2'</span>], hemesh:HeMesh</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'n_hes'</span>]:</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Compute lengths of dual edges. Boundary dual edges get length jnp.nan. Negative sign = flipped edge.</em></p>
<div id="51a6342f-fd8c-44d4-8f68-f4bbee5c2fd2" class="cell" data-execution_count="65">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, mesh.vertices, mesh.face_positions)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="d452e19f-c44f-4dd5-96e7-7b8c1f551f39" class="cell" data-scrolled="true" data-execution_count="66">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>geommesh.vertices.T, hemesh.faces)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.gca()</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>             cell_colors<span class="op">=</span>np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.1</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>})</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>plt.gca().add_collection(p)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>(np.float64(-1.10003475),
 np.float64(1.09628575),
 np.float64(-1.09934025),
 np.float64(1.09050125))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-62-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="55e7cfc0-2d38-4a21-b0fa-a7c47b16135a" class="cell" data-execution_count="67">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># edges and dual edges should be orthogonal since we are using circumcenters</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>edges <span class="op">=</span> geommesh.vertices[hemesh.orig]<span class="op">-</span>geommesh.vertices[hemesh.dest]</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>dual_edges <span class="op">=</span> (geommesh.face_positions[hemesh.heface]</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>              <span class="op">-</span>geommesh.face_positions[hemesh.heface[hemesh.twin]])</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>jnp.allclose(jnp.einsum(<span class="st">'vi,vi-&gt;v'</span>, edges[<span class="op">~</span>hemesh.is_bdry_edge], dual_edges[<span class="op">~</span>hemesh.is_bdry_edge]), <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>Array(True, dtype=bool)</code></pre>
</div>
</div>
<div id="7d39c278-7566-4096-ab99-31f8a01c681d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># computing the signed edge length shows that there are some "flipped" edges.</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>signed_squared_length <span class="op">=</span> jnp.einsum(<span class="st">'vi,vi-&gt;v'</span>, edges, dual_edges <span class="op">@</span> trig.get_rot_mat(np.pi<span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>jnp.where((signed_squared_length <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.0</span>) <span class="op">&amp;</span> <span class="op">~</span>hemesh.is_bdry_edge )[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>Array([  9, 185, 191, 335, 363, 539, 545, 689], dtype=int64)</code></pre>
</div>
</div>
<div id="9eca3b8e" class="cell" data-execution_count="69">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="bu">isinstance</span>(<span class="dv">335</span>, <span class="bu">int</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>True</code></pre>
</div>
</div>
<div id="d967f938-a498-49cc-91f7-a392ba5ad068" class="cell" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flip edge and recompute face positions</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>flipped_hemesh <span class="op">=</span> flip_edge(hemesh, e<span class="op">=</span><span class="dv">335</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>flipped_geommesh <span class="op">=</span> set_voronoi_face_positions(geommesh, flipped_hemesh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9b047482-87c1-4607-bb44-f13ab9beb0af" class="cell" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># connectivity is still valid</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>igl.is_edge_manifold(hemesh.faces)[<span class="dv">0</span>], igl.is_edge_manifold(flipped_hemesh.faces)[<span class="dv">0</span>], flipped_hemesh.iterate_around_vertex(<span class="dv">100</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>(True, True, Array([298, 299, 630, 632], dtype=int64))</code></pre>
</div>
</div>
<div id="998a6c7e-cc30-4bcf-924f-1701ce93b1f3" class="cell" data-execution_count="72">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># you can see the flipped edge in the plot below - it's where the blue mesh forms a "bow-tie"</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>geommesh.vertices.T, hemesh.faces)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>flipped_geommesh.vertices.T, flipped_hemesh.faces)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.gca()</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>         cell_colors<span class="op">=</span>np.array([<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>})</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> cellplot(flipped_hemesh, flipped_geommesh.face_positions,</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>              cell_colors<span class="op">=</span>np.array([<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"tab:orange"</span>})</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>ax.add_collection(p1)</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>ax.add_collection(p2)</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>label_plot(geommesh.vertices, hemesh.faces, fontsize<span class="op">=</span><span class="dv">10</span>, face_labels<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="repeated-flips" class="level4">
<h4 class="anchored" data-anchor-id="repeated-flips">Repeated flips</h4>
<p>In a simulation, we need to carry out edge flips at every timestep. The function <code>flip_edge(hemesh: HeMesh, e: int) -&gt; HeMesh</code> does a single edge flip by modifying the connectivity arrays. Luckily, it is already JAX-compatible (we can JIT-compile it).</p>
<p>The next goal is to carry out multiple flips. We must be careful: doing multiple flips “simultaneously” risks leaving the mesh in an inconsistent state. Instead, we do the flips in sequence. To make things JAX-compatible, we do a <code>jax.lax.scan</code> scan over all half-edges.</p>
<div id="69320efd-505e-44af-9b28-f50a00e7fc53" class="cell" data-execution_count="73">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, mesh.vertices, mesh.face_positions)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="94b30732-54cb-495f-baf7-0faecb9c99f3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>dual_lengths <span class="op">=</span> get_signed_dual_he_length(geommesh.vertices, geommesh.face_positions, hemesh)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>edges <span class="op">=</span> jnp.where((dual_lengths <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.05</span>) <span class="op">&amp;</span> <span class="op">~</span>hemesh.is_bdry_edge <span class="op">&amp;</span> hemesh.is_unique)[<span class="dv">0</span>]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we only want to flip unique hes!</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>edges, edges.size</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>(Array([  9, 185, 191, 335], dtype=int64), 4)</code></pre>
</div>
</div>
<div id="b281b408-08b1-4ae2-9c79-8ffbc4db4de4" class="cell" data-scrolled="true" data-execution_count="75">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scan over indices of negative-length edges. </span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>flipped_hemesh, _ <span class="op">=</span> jax.lax.scan(<span class="kw">lambda</span> h, e: (flip_edge(h, e), <span class="va">None</span>) , init<span class="op">=</span>hemesh, xs<span class="op">=</span>edges)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this scan is over an array whose shape varies. Instead, we can scan over all hes, and flip only if the length is negative (via jax.lax.cond).</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L800" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="flip_all" class="level3">
<h3 class="anchored" data-anchor-id="flip_all">flip_all</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flip_all(</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    hemesh:HeMesh, to_flip:Bool[Array, <span class="st">'n_hes'</span>]</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>HeMesh:</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Flip all (unique) half-edges where to_flip is True in a half-edge mesh. Wraps flip_edge.</em></p>
<div id="537a9784-2300-468a-9286-276464f97b72" class="cell" data-execution_count="77">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>to_flip <span class="op">=</span> (dual_lengths <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> <span class="op">~</span>jnp.isnan(dual_lengths)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>flipped_hemesh <span class="op">=</span> flip_all(hemesh, to_flip<span class="op">=</span>to_flip)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0ca16bb5-4865-4f87-ad92-fe5a290f8983" class="cell" data-execution_count="78">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>flipped_hemesh <span class="op">=</span> flip_all(hemesh, to_flip<span class="op">=</span>(dual_lengths<span class="op">&lt;</span><span class="fl">0.02</span>)) <span class="co"># no extra recompile</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9a6c0ce3-b7af-4951-aa50-11613294b86e" class="cell" data-execution_count="79">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>flipped_geommesh <span class="op">=</span> set_voronoi_face_positions(geommesh, flipped_hemesh)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2c38754f-750d-4da6-834e-bf030f2ab086" class="cell" data-execution_count="80">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>geommesh.vertices.T, hemesh.faces)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>plt.triplot(<span class="op">*</span>flipped_geommesh.vertices.T, flipped_hemesh.faces)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.gca()</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.gca()</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="op">=</span> cellplot(hemesh, geommesh.face_positions,</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>         cell_colors<span class="op">=</span>np.array([<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"k"</span>})</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>p2 <span class="op">=</span> cellplot(flipped_hemesh, flipped_geommesh.face_positions,</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>              cell_colors<span class="op">=</span>np.array([<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>,<span class="fl">0.</span>]), mpl_polygon_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">1</span>, <span class="st">"ec"</span>: <span class="st">"tab:orange"</span>})</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>ax.add_collection(p1)</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>ax.add_collection(p2)</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"equal"</span>)</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>label_plot(geommesh.vertices, hemesh.faces, fontsize<span class="op">=</span><span class="dv">10</span>, face_labels<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_triangulation_datastructure_files/figure-html/cell-76-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="adjacency-like-operators-on-half-edge-meshes" class="level2">
<h2 class="anchored" data-anchor-id="adjacency-like-operators-on-half-edge-meshes">Adjacency-like operators on half-edge meshes</h2>
<section id="computing-cell-areas-perimeters-etc-via-corners" class="level3">
<h3 class="anchored" data-anchor-id="computing-cell-areas-perimeters-etc-via-corners">Computing cell areas, perimeters, etc via corners</h3>
<p>To compute, for instance, the cell area using the shoelace formula, you need to iterate around the faces adjacent to a vertex. This is not straightforward to vectorize because the number of adjacent faces per vertex can vary (there can be 5-, 6-, 7-sided cells etc.). That is, the list of adjacent faces is a “ragged” array. However, vectorization is essential for numerical efficiency and compatibility with JAX. For example, we may want to compute an energy and its gradient, which depends on cell areas. One way to solve this is a scheme in which the lists of adjacent faces are “padded” in some manner, so that they are all the same length. This is cumbersome.</p>
<p>Instead, let us split all “cell-based” quantities into contributions from “corners”, i.e., half-edges, like this:</p>
<p><img src="01_triangulation_datastructure_files/figure-html/35104309-d38f-4e0f-b64a-de86a49efa0d-1-e1bd53c0-c2f2-4413-af9d-a74a1592993a.png" class="img-fluid" alt="image.png"> Source: <a href="https://doc.cgal.org/latest/Weights/group__PkgWeightsRefVoronoiRegionWeights.html">CGAL</a></p>
<p>To compute the total area, we can sum over all half-edges <span class="math inline">\((r,p)\)</span> opposite to a vertex <span class="math inline">\(q\)</span>. Numerically, this can be achieved efficiently using gather/scatter operations.</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L823" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="sum_he_to_vertex_opposite" class="level3">
<h3 class="anchored" data-anchor-id="sum_he_to_vertex_opposite">sum_he_to_vertex_opposite</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_he_to_vertex_opposite(</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    hemesh:HeMesh, he_field:Float[Array, <span class="st">'n_hes ...'</span>]</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Sum a half-edge field onto opposite vertices.</em></p>
<p>hemesh: connectivity information he_field: (n_hes,) or (n_hes, d) array</p>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L811" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="sum_he_to_vertex_incoming" class="level3">
<h3 class="anchored" data-anchor-id="sum_he_to_vertex_incoming">sum_he_to_vertex_incoming</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_he_to_vertex_incoming(</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    hemesh:HeMesh, he_field:Float[Array, <span class="st">'n_hes ...'</span>]</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Sum a half-edge field onto destination vertices.</em></p>
<p>hemesh: connectivity information he_field: (n_hes,) or (n_hes, d) array</p>
<div id="12e6b835-4263-4314-99f4-6974e5fea082" class="cell" data-execution_count="82">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># TO DO: implement gradient (vertex -&gt; face) and cotan-Laplacian (vertex -&gt; vertex) using gather/scatter ops like above .</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># compare with igl to check correctness.</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4006c7fb-56a2-445c-9647-017dc017074e" class="cell" data-execution_count="83">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>geommesh <span class="op">=</span> GeomMesh(<span class="op">*</span>hemesh.n_items, mesh.vertices, mesh.face_positions)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/nikolas-claussen/triangulax/blob/main/triangulax/mesh.py#L836" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_cell_areas" class="level3">
<h3 class="anchored" data-anchor-id="get_cell_areas">get_cell_areas</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cell_areas(</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    geommesh:GeomMesh, hemesh:HeMesh</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span>Float[Array, <span class="st">'n_vertices'</span>]:</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Compute areas of cells by mesh traversal (don’t use for simulation, inefficient).</em></p>
<p>Boundary vertices get area 0.</p>
<div id="5618181e-7193-48af-ac45-c1b3d77c4df3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Let's use the adjacency matrix to compute the area of all cells. First, compute all corner areas</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>a, b, c <span class="op">=</span> (hemesh.dest[hemesh.nxt], hemesh.dest[hemesh.prv], hemesh.dest)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>corner_areas <span class="op">=</span> jax.vmap(trig.get_voronoi_corner_area)(geommesh.vertices[a], geommesh.vertices[b], geommesh.vertices[c])</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>cell_areas_corner <span class="op">=</span> sum_he_to_vertex_opposite(hemesh, corner_areas)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>cell_areas_corner <span class="op">=</span> cell_areas_corner.at[hemesh.is_bdry].<span class="bu">set</span>(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="462432a9-100a-400c-9942-9eb1643b05bb" class="cell" data-execution_count="86">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for comparison, compute the areas by mesh traversal</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>cell_areas_iterative <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span>get_cell_areas(geommesh, hemesh)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">abs</span>(cell_areas_iterative<span class="op">-</span>cell_areas_corner).<span class="bu">max</span>() <span class="co"># works!</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>np.float64(4.85722573273506e-17)</code></pre>
</div>
</div>
<div id="64840cc3-641c-4076-bbef-802d67cf3e4c" class="cell" data-execution_count="87">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using the gather/scatter trick, we can also compute the coordination number</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>sum_he_to_vertex_incoming(hemesh, jnp.ones(hemesh.n_hes)).at[hemesh.is_bdry].<span class="bu">set</span>(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>Array([0., 6., 6., 7., 6., 6., 6., 6., 6., 0., 0., 6., 6., 5., 6., 6., 6.,
       5., 5., 6., 0., 0., 6., 6., 6., 7., 5., 6., 6., 7., 7., 6., 0., 0.,
       0., 7., 6., 6., 5., 7., 6., 6., 6., 6., 7., 5., 0., 0., 5., 6., 6.,
       7., 7., 5., 6., 6., 7., 5., 0., 5., 7., 6., 5., 6., 5., 6., 7., 6.,
       5., 0., 0., 5., 6., 6., 6., 6., 6., 7., 6., 6., 0., 6., 6., 5., 6.,
       0., 0., 6., 6., 6., 7., 0., 6., 6., 6., 5., 6., 6., 6., 0., 0., 6.,
       6., 6., 6., 7., 6., 0., 0., 5., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 6., 6., 6., 6., 6., 6., 0.], dtype=float64)</code></pre>
</div>
</div>
</section>
</section>
<section id="saving-to-disk" class="level2">
<h2 class="anchored" data-anchor-id="saving-to-disk">Saving to disk</h2>
<p>We save and load <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#trimesh"><code>TriMesh</code></a> meshes as standard <code>.obj</code> files (with the hack of using <code>vn</code> lines for the face positions). The <a href="https://nikolas-claussen.github.io/triangulax/triangulation_datastructure.html#hemesh"><code>HeMesh</code></a> class is basically a collection of arrays, which we can save to disk using <code>numpy</code>.</p>
<div id="100dfc0a" class="cell" data-execution_count="88">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tempfile <span class="im">import</span> TemporaryFile</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7f1a720a-df0e-4a7e-97cb-715bb3ef687b" class="cell" data-execution_count="89">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>mesh <span class="op">=</span> TriMesh.read_obj(<span class="st">"test_meshes/disk.obj"</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>hemesh <span class="op">=</span> HeMesh.from_triangles(mesh.vertices.shape[<span class="dv">0</span>], mesh.faces)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: readOBJ() ignored non-comment line 3:
  o flat_tri_ecmc</code></pre>
</div>
</div>
<div id="900dc102-544f-43a9-ba4b-70338e6b0d71" class="cell" data-execution_count="90">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is how to use np.savenpz</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>outfile <span class="op">=</span> TemporaryFile()</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">10</span>)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.sin(x)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>np.savez(outfile, x<span class="op">=</span>x, y<span class="op">=</span>y)</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> outfile.seek(<span class="dv">0</span>) <span class="co"># simulates closing &amp; reopening file</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>npzfile <span class="op">=</span> np.load(outfile)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span>(npzfile.files), npzfile[<span class="st">'x'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>(['x', 'y'], array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]))</code></pre>
</div>
</div>
<div id="72fd2f37-fd33-4abc-9fba-2f3e67cc4b2b" class="cell" data-scrolled="true" data-execution_count="91">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>outfile <span class="op">=</span> TemporaryFile()</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>hemesh.save(outfile)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> outfile.seek(<span class="dv">0</span>) <span class="co"># simulates closing &amp; reopening file</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>npzfile <span class="op">=</span> np.load(outfile)</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>npzfile.files</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>['incident',
 'orig',
 'dest',
 'twin',
 'nxt',
 'prv',
 'heface',
 'face_incident',
 'inf_vertices']</code></pre>
</div>
</div>
<div id="dac3d617-05e8-4293-951c-092530c44832" class="cell" data-execution_count="92">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>outfile <span class="op">=</span> TemporaryFile()</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>hemesh.save(outfile)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> outfile.seek(<span class="dv">0</span>) <span class="co"># simulates closing &amp; reopening file</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>reloaded <span class="op">=</span> HeMesh.load(outfile)</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>np.allclose(reloaded.faces, hemesh.faces)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>True</code></pre>
</div>
</div>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">Next steps</h3>
<p>Looks good - the JAX-compatible triangular-mesh data structures seem to work. In particular, the tricky T1/edge-flip function. Next steps: toy simulation, notebook 01.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nikolas-claussen\.github\.io\/triangulax");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nikolas-claussen/triangulax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>